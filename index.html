<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Esthetics Auto CashBook</title>
<meta name="theme-color" content="#0b3b6d">
<meta name="description" content="Esthetics Auto CashBook - Professional Business Management">
<meta name="keywords" content="cashbook, business, accounting, auto, esthetics">

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
  :root{
    --brand:#0b3b6d;--brand-2:#1e6fd9;--bg:#f4f6f9;--card:#fff;--text:#1f2937;--muted:#6b7280;--danger:#dc3545;--shadow:0 6px 16px rgba(0,0,0,.08);--radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{background:linear-gradient(180deg,var(--brand),#062945);color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:5;box-shadow:var(--shadow)}
  .title{font-weight:900;font-size:18px;display:flex;gap:10px;align-items:center}
  nav button{background:transparent;border:none;color:#e5efff;font-weight:700;margin-left:12px;padding:8px 10px;border-radius:8px;cursor:pointer}
  nav button.active,nav button:hover{background:rgba(255,255,255,.12);color:#fff}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .hidden{display:none}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .card-title{font-weight:800;color:var(--brand);margin-bottom:10px;display:flex;align-items:center;gap:8px}
  .btn{padding:8px 12px;border:none;border-radius:10px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--brand-2);color:#fff}
  .btn-secondary{background:#64748b;color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-ghost{background:#eef2f7;color:#111}
  .btn-warning{background:#f59e0b;color:#fff}
  .btn-success{background:#16a34a;color:#fff}
  .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .form-group label{display:block;font-size:12px;font-weight:800;color:var(--muted);margin:4px 0;letter-spacing:.4px;text-transform:uppercase}
  .form-group input,.form-group select{width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
  th,td{padding:10px;border-top:1px solid #eef2f7;text-align:left}
  thead th{background:var(--brand);color:#fff;border-top:none}
  .action-btn{background:transparent;border:none;padding:6px 8px;border-radius:8px;cursor:pointer}
  .action-btn:hover{background:#eef6ff}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{background:#f3f4f6;border-radius:999px;padding:4px 10px;font-size:12px;display:inline-flex;align-items:center;gap:8px}
  .chip button{border:none;background:transparent;color:#ef4444;cursor:pointer}
  footer{background:#0b3b6d;color:#fff;text-align:center;padding:10px}
  .income {color: #16a34a; font-weight: 600;}
  .expense {color: #dc2626; font-weight: 600;}
  
   /* For negative amounts in dashboard */
  .negative-amount {
    color: #dc2626;
    font-weight: 600;
  }
  
  /* For positive amounts in dashboard */
  .positive-amount {
    color: #16a34a;
    font-weight: 600;
  }
  
  /* Different colors for Today's Summary */
  .today-positive-amount {
    color: #059669;
    font-weight: 600;
  }
  
  .today-negative-amount {
    color: #b91c1c;
    font-weight: 600;
  }
  
  /* For employee status */
  .status-active {
    color: #059669;
    font-weight: 600;
  }
  
  .status-inactive {
    color: #dc2626;
    font-weight: 600;
  }
  
  .status-warning {
    color: #d97706;
    font-weight: 600;
  }
  
  /* For payroll table styling */
  .payroll-table {
    font-size: 13px;
  }
  
  .payroll-table th {
    padding: 8px;
  }
  
  .payroll-table td {
    padding: 8px;
  }
  
  /* For visa expiry warning */
  .visa-warning {
    background-color: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
  }
  
  /* NEW: For attendance status */
  .attendance-present {
    color: #059669;
    font-weight: 600;
  }
  
  .attendance-absent {
    color: #dc2626;
    font-weight: 600;
  }
  
  .attendance-leave {
    color: #2563eb;
    font-weight: 600;
  }
  
  /* NEW: For advance status */
  .advance-pending {
    color: #d97706;
    font-weight: 600;
  }
  
  .advance-paid {
    color: #059669;
    font-weight: 600;
  }
  
  /* NEW: For smaller salary slip */
  .salary-slip-small {
    font-size: 12px;
    padding: 10px;
  }
  
  .salary-slip-small th, 
  .salary-slip-small td {
    padding: 4px;
  }
  
  /* For employee photo preview */
  .employee-photo-preview {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    margin-top: 8px;
  }

  /* --- Type toggle buttons (income/expense) --- */
  .type-toggle{display:flex;gap:8px;align-items:center}
  .btn-toggle{padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;font-weight:700;cursor:pointer;background:#eef2f7}
  .btn-toggle.active{color:#fff}
  .btn-toggle.income.active,
  .btn-toggle.expense.active {background:#16a34a;color:#fff;border-color:#16a34a}
  .hidden-select{display:none !important;}
  /* Vehicle Report Summary cards */
  .vr-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;min-width:180px}
  .vr-title{font-weight:800;color:var(--brand);font-size:13px;margin-bottom:6px}
  .vr-value{font-size:20px;font-weight:900}


  /* Ensure toggle buttons are clickable on all layouts */
  .btn-toggle{position:relative; z-index:1; pointer-events:auto}
  .type-toggle{position:relative}


#vehicleReportCard{border:1px solid #e5e7eb}

/* ==== Modern Animated Buttons (Injected by ChatGPT) ==== */
:root{
  --btn-radius: 12px;
  --btn-shadow: 0 8px 18px rgba(0,0,0,.12);
}

/* Base: nav buttons + .btn + .nav-btn */
nav button, .btn, .nav-btn {
  position: relative;
  overflow: hidden;
  transition: transform .25s ease, box-shadow .25s ease, filter .25s ease, background .25s ease;
  border-radius: var(--btn-radius);
  will-change: transform, box-shadow, filter;
}

/* Subtle glossy sweep on hover */
nav button::before, .btn::before, .nav-btn::before {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(120deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.0) 100%);
  transform: translateX(-120%);
  transition: transform .45s ease;
  pointer-events: none;
}

nav button:hover::before,
.btn:hover::before,
.nav-btn:hover::before {
  transform: translateX(0%);
}

nav button:hover, .btn:hover, .nav-btn:hover {
  transform: translateY(-3px) scale(1.015);
  box-shadow: var(--btn-shadow);
  filter: brightness(1.05);
}

/* Active press */
nav button:active, .btn:active, .nav-btn:active {
  transform: translateY(-1px) scale(0.995);
  filter: brightness(0.98);
}

/* Top Header Nav: give solid modern gradients + equal size */
header nav button {
  min-width: 130px;
  text-align: center;
  padding: 10px 14px;
  font-weight: 800;
  letter-spacing: .2px;
  color: #fff;
  border: none;
}

/* Individual themed gradients for quick visual recognition */
#btnDashboard { background: linear-gradient(135deg, #22c55e, #16a34a); }
#btnTransactions { background: linear-gradient(135deg, #60a5fa, #2563eb); }
#btnEmployees { background: linear-gradient(135deg, #8b5cf6, #6d28d9); color:#fff; }
#btnParts { background: linear-gradient(135deg, #14b8a6, #0f766e); color:#fff; }
#btnSettings { background: linear-gradient(135deg, #9ca3af, #4b5563); }

/* Keep :hover bright and :active slightly dim so selection feels snappy */
#btnDashboard:hover,
#btnTransactions:hover,
#btnEmployees:hover,
#btnParts:hover,
#btnSettings:hover { filter: brightness(1.12); }

/* Active state ring */
header nav button.active {
  outline: 2px solid rgba(255,255,255,.65);
  outline-offset: 0;
}

/* System Buttons (.btn variants) – subtle modern look */
.btn-primary{ background: linear-gradient(135deg, var(--brand-2), #1d4ed8); }
.btn-secondary{ background: linear-gradient(135deg, #94a3b8, #64748b); }
.btn-danger{ background: linear-gradient(135deg, #ef4444, #b91c1c); }
.btn-warning{ background: linear-gradient(135deg, #f59e0b, #b45309); }
.btn-success{ background: linear-gradient(135deg, #22c55e, #15803d); }
.btn-ghost{ background: #eef2f7; }

/* Parts iframe navigation (.nav-btn) – match the new style */
.nav-btn{
  background: linear-gradient(135deg, #2c3e50, #1a2530);
  color:#fff;
  border:none;
  padding: 12px 18px;
}

.nav-btn.active{
  background: linear-gradient(135deg, #60a5fa, #2563eb);
}
/* ==== End Injected Styles ==== */

/* ==== Current Page Active Button Highlight (Injected) ==== */
header nav button.active {
  background: linear-gradient(135deg, #f59e0b, #d97706) !important; /* Orange-Gold Gradient */
  color: #fff !important;
  box-shadow: 0 0 12px rgba(245, 158, 11, 0.6);
  transform: scale(1.05);
  border: 2px solid rgba(255,255,255,0.6);
  font-size: 15px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Enhanced Storage will be loaded after main app -->
</head>
<body>
<header>
<div class="title"><i class="fa-solid fa-car"></i> Esthetics Auto CashBook</div>
<nav class="hidden" id="menu">
<button id="btnDashboard" onclick="showSection('dashboard'); try{loadDashboardTransactions()}catch(e){}">Dashboard</button>
<button class="active" id="btnTransactions" onclick="showSection('transactions')">Transactions</button>
<button id="btnEmployees" onclick="showSection('employees')">Employees</button>
<button id="btnParts" onclick="showSection('parts')">Parts</button>
<button id="btnSettings" onclick="showSection('settings')">Settings</button></nav>
</header>
<div class="container">
<!-- LOGIN -->
<section class="card" id="loginScreen" style="max-width:480px;margin:40px auto;">
<div class="card-title"><i class="fa-solid fa-right-to-bracket"></i> Login</div>
<div class="form-row">
<div class="form-group"><label>Username</label><input autocomplete="username" class="standard-field" id="loginUser"/></div>
<div class="form-group"><label>Password</label><input autocomplete="current-password" class="standard-field" id="loginPass" onkeypress="handleLoginKeyPress(event)" type="password"/></div>
</div>
<div style="margin-top:10px;display:flex;gap:8px;justify-content:space-between;align-items:center;">
<button class="btn btn-primary" onclick="login()">Login</button>
<span style="font-size:12px;color:#6b7280;">Welcome to Esthetics Auto CashBook</span>
</div>
</section>
<!-- APP -->
<div class="hidden" id="app">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
<div>Welcome, <b id="currentUser"></b></div>
<button class="btn btn-secondary" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</button>
</div>
<!-- DASHBOARD -->
<section class="card hidden" id="dashboardSection">




<div class="card-title"><i class="fa-solid fa-gauge-high"></i> Dashboard</div>
<!-- Today's Summary -->
<div class="card-title" style="margin-top:8px;"><i class="fa-solid fa-calendar-day"></i> Today's Summary</div>
<div id="todaySummary" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;"></div>
<!-- Account Summary -->
<div class="card-title"><i class="fa-solid fa-chart-pie"></i> Account Summary</div>
<div id="accountSummary" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;"></div>
<!-- Total Summary -->
<div class="card-title"><i class="fa-solid fa-chart-simple"></i> Total Summary</div>
<div id="dashboardSummary" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;"></div>

<!-- Recent Transactions -->
<div class="card" id="vehicleReportCard">
  <div class="card-title"><i class="fa-solid fa-car-side"></i> Vehicle Report</div>
  <div class="form-row">
    <div class="form-group">
      <label>Start Date</label>
      <input id="vrStartDate" class="standard-field" type="date" />
    </div>
    <div class="form-group">
      <label>End Date</label>
      <input id="vrEndDate" class="standard-field" type="date" />
    </div>

    <div class="form-group">
      <label>Vehicle ID / Number</label>
      <input id="vrVehicleId" class="standard-field" placeholder="e.g. ABC-12345" />
    </div>
    <div class="form-group" style="align-self:end;">
      <button class="btn btn-primary" onclick="runVehicleReport()"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
      <button class="btn btn-ghost" onclick="clearVehicleReport()"><i class="fa-solid fa-eraser"></i> Clear</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="card-title"><i class="fa-solid fa-chart-line"></i> Summary</div>
    <div id="vrSummary" style="display:flex;gap:12px;flex-wrap:wrap;"></div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="card-title"><i class="fa-solid fa-table"></i> Matching Entries</div>
    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <button class="btn btn-secondary" onclick="exportVehicleReportExcel()"><i class="fa-solid fa-file-excel"></i> Export Excel</button>
      <button class="btn btn-danger" onclick="exportVehicleReportPDF()"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
    </div>
    <div style="overflow:auto;">
      <table id="vehicleReportTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Vehicle ID</th>
            <th>Vendor</th>
            <th>Account</th>
            <th>Amount (AED)</th>
            <th>Description</th>
            <th>Type</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div><hr/>
<div class="card-title" style="margin-top:16px;"><i class="fa-solid fa-receipt"></i> Recent Transactions (Last 50)</div>
<div class="card-title" style="margin-top:8px;"><i class="fa-solid fa-filter"></i> Filters &amp; Export</div>
<div class="form-row">
<div class="form-group"><label>Start Date</label><input class="standard-field" id="filterStart" type="date"/></div>
<div class="form-group"><label>End Date</label><input class="standard-field" id="filterEnd" type="date"/></div>
<div class="form-group"><label>Category</label><select class="standard-field" id="filterCategory"></select></div>
<div class="form-group"><label>Account</label><select class="standard-field" id="filterAccount"></select></div>
<div class="form-group"><label>Type</label>
<select class="standard-field" id="filterType">
<option value="">All</option>
<option value="income">Income</option>
<option value="expense">Expense</option>
</select>
</div>
</div>
<div style="display:flex;gap:8px;margin-top:8px;">
<button class="btn btn-primary" onclick="applyFilters(true)"><i class="fa-solid fa-magnifying-glass"></i> Apply Filters</button>
<button class="btn btn-ghost" onclick="clearFilters()">Clear</button>
<button class="btn btn-secondary" id="exportBtn" onclick="exportExcel()"><i class="fa-solid fa-file-excel"></i> Export Excel</button>
<button class="btn btn-danger" id="exportPdfBtn" onclick="exportPDF()"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
</div>
<div style="overflow:auto;">
<table id="dashboardTransactionsTable">
<thead>
<tr>
<th>Date</th>
<th>Category</th>
<th>ID</th>
<th>Vendor</th>
<th>Account</th>
<th>Amount (AED)</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>
<!-- TRANSACTIONS -->
<section class="hidden" id="transactionsSection">
<div class="card">
<div class="card-title"><i class="fa-solid fa-plus"></i> Add Transaction</div>
<form id="transactionForm">
<div class="form-row">
<div class="form-group"><label>Date</label><input class="standard-field" id="date" required="" type="date"/></div>
<div class="form-group"><label>Category</label><select class="standard-field" id="category" required=""></select></div>
<div class="form-group"><label>ID / Others</label><input class="standard-field" id="transactionId" placeholder="Optional" type="text"/></div>
<div class="form-group"><label>Vendor Name</label><input class="standard-field" id="vendor" placeholder="Optional" type="text"/></div>
<div class="form-group"><label>Account By</label><select class="standard-field" id="account" required=""></select></div>
<div class="form-group"><label for="amount">Amount (AED)</label><input class="standard-field" id="amount" min="0" required="" step="0.01" type="number" pattern="[0-9]+(\.[0-9]+)?" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1')"/></div>
<div class="form-group">
  <label>Type</label>
  <div class="type-toggle">
    <button type="button" id="btnTypeIncome" class="btn-toggle income" onclick="setTxnType('income')">Income</button>
    <button type="button" id="btnTypeExpense" class="btn-toggle expense" onclick="setTxnType('expense')">Expense</button>
  </div>
  <select class="hidden-select standard-field" id="transactionType">
    <option value="income">Income</option>
    <option value="expense">Expense</option>
  </select>
  </div>
<div class="form-group" style="grid-column:1/-1;"><label>Description</label><input class="standard-field" id="description" placeholder="Optional" type="text"/></div>
</div>
<div style="display:flex;gap:8px;margin-top:8px;">
<button class="btn btn-primary" type="submit"><i class="fa-solid fa-floppy-disk"></i> Save</button>
<button class="btn btn-ghost" onclick="resetForm()" type="button">Reset</button>
</div>
</form>
</div>
<div class="card">
<div class="card-title"><i class="fa-solid fa-list"></i> Transactions</div>
<div style="overflow:auto;">
<table id="transactionsTable">
<thead>
<tr>
<th>Date</th>
<th>Category</th>
<th>ID</th>
<th>Vendor</th>
<th>Account</th>
<th>Amount (AED)</th>
<th>Description</th>
<th>Type</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div style="margin-top:6px;font-size:12px;color:#6b7280;">
          Note: Only the creator can edit/delete their entry for 10 minutes after creation. Admins can edit/delete anytime.
        </div>
</div>
</section>
<!-- EMPLOYEES SECTION -->
<section class="hidden" id="employeesSection">
<!-- Visa Expiry Reminder -->
<div class="card" id="visaReminders"></div>
<!-- Add Employee Form -->
<div class="card">
<div class="card-title"><i class="fa-solid fa-user-plus"></i> Add Employee</div>
<form id="employeeForm">
<div class="form-row">
<div class="form-group"><label>Full Name</label><input class="standard-field" id="empName" required="" type="text"/></div>
<div class="form-group"><label>Position</label><input class="standard-field" id="empPosition" required="" type="text"/></div>
<div class="form-group"><label>Phone Number</label><input class="standard-field" id="empPhone" type="tel"/></div>
<div class="form-group"><label>Email</label><input class="standard-field" id="empEmail" type="email"/></div>
<div class="form-group"><label>Date of Birth</label><input class="standard-field" id="empDob" type="date"/></div>
<div class="form-group"><label>Employee Photo</label>
<input accept="image/*" class="standard-field" id="empPhoto" onchange="previewEmployeePhoto(event)" type="file"/>
<img class="employee-photo-preview" id="empPhotoPreview" src="" style="display:none;"/>
</div>
<div class="form-group"><label>Basic Salary (AED)</label><input class="standard-field" id="empSalary" min="0" required="" step="0.01" type="number"/></div>
<div class="form-group"><label>Housing Allowance (AED)</label><input class="standard-field" id="empHousing" min="0" step="0.01" type="number" value="0"/></div>
<div class="form-group"><label>Transport Allowance (AED)</label><input class="standard-field" id="empTransport" min="0" step="0.01" type="number" value="0"/></div>
<div class="form-group"><label>Other Allowance (AED)</label><input class="standard-field" id="empOther" min="0" step="0.01" type="number" value="0"/></div>
<div class="form-group"><label>Visa Number</label><input class="standard-field" id="empVisa" type="text"/></div>
<div class="form-group"><label>Visa Expiry Date</label><input class="standard-field" id="empVisaExpiry" type="date"/></div>
<div class="form-group"><label>Passport Number</label><input class="standard-field" id="empPassport" type="text"/></div>
<div class="form-group"><label>Passport Expiry Date</label><input class="standard-field" id="empPassportExpiry" type="date"/></div>
<div class="form-group"><label>Status</label>
<select class="standard-field" id="empStatus">
<option value="active">Active</option>
<option value="inactive">Inactive</option>
</select>
</div>
</div>
<div style="display:flex;gap:8px;margin-top:8px;">
<button class="btn btn-primary" type="submit"><i class="fa-solid fa-floppy-disk"></i> Save Employee</button>
<button class="btn btn-ghost" onclick="resetEmployeeForm()" type="button">Reset</button>
</div>
</form>
</div>
<!-- Employees List -->
<div class="card">
<div class="card-title"><i class="fa-solid fa-users"></i> Employees List</div>
<div style="display:flex;gap:8px;margin-bottom:12px;">
<button class="btn btn-secondary" onclick="exportEmployeesExcel()"><i class="fa-solid fa-file-excel"></i> Export to Excel</button>
<button class="btn btn-danger" onclick="exportEmployeesPDF()"><i class="fa-solid fa-file-pdf"></i> Export to PDF</button>
<button class="btn btn-warning" onclick="exportEmployeeFullReport()"><i class="fa-solid fa-file-excel"></i> Full Employee Report</button>
</div>
<div style="overflow:auto;">
<table id="employeesTable">
<thead>
<tr>
<th>Name</th>
<th>Position</th>
<th>Salary (AED)</th>
<th>Visa Expiry</th>
<th>Passport Expiry</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
<tr><td>Ali Khan</td><td>Manager</td><td>8000</td><td>2026-05-01</td><td>2027-01-10</td><td>Active</td><td>-</td></tr>
<tr><td>Sara Ahmed</td><td>Accountant</td><td>5000</td><td>2025-12-15</td><td>2026-08-20</td><td>Active</td><td>-</td></tr>
<tr><td>Bilal Hussain</td><td>Driver</td><td>3000</td><td>2025-11-01</td><td>2026-06-30</td><td>Inactive</td><td>-</td></tr>
</tbody></table></div></div><!-- NEW: Advance Management -->
<div class="card">
<div class="card-title"><i class="fa-solid fa-money-bill-transfer"></i> Advance Management</div>
<div class="form-row">
<div class="form-group"><label>Select Employee</label><select class="standard-field" id="advanceEmployee"></select></div>
<div class="form-group"><label>Advance Date</label><input class="standard-field" id="advanceDate" required="" type="date"/></div>
<div class="form-group"><label>Advance Amount (AED)</label><input class="standard-field" id="advanceAmount" min="0" required="" step="0.01" type="number"/></div>
<div class="form-group"><label>Reason</label><input class="standard-field" id="advanceReason" type="text"/></div>
<div class="form-group" style="align-self:end;"><button class="btn btn-primary" onclick="addAdvance()"><i class="fa-solid fa-plus"></i> Add Advance</button></div>
</div>
<div style="overflow:auto;margin-top:16px;">
<table class="payroll-table" id="advancesTable">
<thead>
<tr>
<th>Date</th>
<th>Employee</th>
<th>Amount (AED)</th>
<th>Reason</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<!-- NEW: Attendance Management -->
<div class="card">
<div class="card-title"><i class="fa-solid fa-calendar-check"></i> Attendance Management</div>
<div class="form-row">
<div class="form-group"><label>Select Employee</label><select class="standard-field" id="attendanceEmployee"></select></div>
<div class="form-group"><label>Attendance Date</label><input class="standard-field" id="attendanceDate" required="" type="date"/></div>
<div class="form-group"><label>Status</label>
<select class="standard-field" id="attendanceStatus">
<option value="present">Present</option>
<option value="absent">Absent</option>
<option value="leave">Leave</option>
<option value="half-day">Half Day</option>
</select>
</div>
<div class="form-group"><label>Notes</label><input class="standard-field" id="attendanceNotes" type="text"/></div>
<div class="form-group" style="align-self:end;"><button class="btn btn-primary" onclick="markAttendance()"><i class="fa-solid fa-check"></i> Mark Attendance</button></div>
</div>
<div class="form-row">
<div class="form-group"><label>Filter by Month</label>
<select class="standard-field" id="filterAttendanceMonth">
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group"><label>Filter by Year</label>
<select class="standard-field" id="filterAttendanceYear"></select>
</div>
<div class="form-group" style="align-self:end;">
<button class="btn btn-primary" onclick="loadAttendance()"><i class="fa-solid fa-filter"></i> Load Attendance</button>
<button class="btn btn-danger" onclick="exportAttendancePDF()"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
</div>
</div>
<div style="overflow:auto;margin-top:16px;">
<table class="payroll-table" id="attendanceTable">
<thead>
<tr>
<th>Date</th>
<th>Employee</th>
<th>Status</th>
<th>Notes</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<!-- Payroll Management -->
<div class="card">
<div class="card-title"><i class="fa-solid fa-money-bill-wave"></i> Payroll Management</div>
<!-- Salary Payment Form -->
<div class="form-row">
<div class="form-group"><label>Select Employee</label><select class="standard-field" id="payrollEmployee"></select></div>
<div class="form-group"><label>Payment Date</label><input class="standard-field" id="payrollDate" required="" type="date"/></div>
<div class="form-group"><label>Payment Month</label>
<select class="standard-field" id="payrollMonth">
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group"><label>Payment Year</label>
<select class="standard-field" id="payrollYear"></select>
</div>
<div class="form-group"><label>Deductions (AED)</label><input class="standard-field" id="payrollDeductions" min="0" step="0.01" type="number" value="0"/></div>
<div class="form-group"><label>Deduction Reason</label><input class="standard-field" id="deductionReason" type="text"/></div>
<div class="form-group"><label>Bonus (AED)</label><input class="standard-field" id="payrollBonus" min="0" step="0.01" type="number" value="0"/></div>
<div class="form-group"><label>Bonus Reason</label><input class="standard-field" id="bonusReason" type="text"/></div>
</div>
<div style="display:flex;gap:8px;margin-top:8px;">
<button class="btn btn-primary" onclick="calculateSalary()"><i class="fa-solid fa-calculator"></i> Calculate Salary</button>
<button class="btn btn-success" disabled="" id="processPaymentBtn" onclick="processPayment()"><i class="fa-solid fa-money-check"></i> Process Payment</button>
<button class="btn btn-secondary" disabled="" id="generateSlipBtn" onclick="generateSalarySlip()"><i class="fa-solid fa-file-invoice"></i> Generate Salary Slip</button>
</div>
<!-- Salary Calculation Preview -->
<div class="card" id="salaryPreview" style="margin-top:16px;display:none;">
<div class="card-title"><i class="fa-solid fa-calculator"></i> Salary Calculation</div>
<div id="salaryDetails"></div>
</div>
</div>
<!-- Payroll History -->
<div class="card">
<div class="card-title"><i class="fa-solid fa-history"></i> Payroll History</div>
<div class="form-row">
<div class="form-group"><label>Filter by Employee</label><select class="standard-field" id="filterPayrollEmployee"></select></div>
<div class="form-group"><label>Filter by Month</label>
<select class="standard-field" id="filterPayrollMonth">
<option value="">All Months</option>
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group"><label>Filter by Year</label>
<select class="standard-field" id="filterPayrollYear">
<option value="">All Years</option>
</select>
</div>
<div class="form-group" style="align-self:end;">
<button class="btn btn-primary" onclick="filterPayrollHistory()"><i class="fa-solid fa-filter"></i> Apply Filter</button>
</div>
</div>
<div style="overflow:auto;margin-top:16px;">
<table class="payroll-table" id="payrollHistoryTable">
<thead>
<tr>
<th>Date</th>
<th>Employee</th>
<th>Month</th>
<th>Basic Salary</th>
<th>Allowances</th>
<th>Deductions</th>
<th>Bonus</th>
<th>Net Salary</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</section>
<!-- SETTINGS (ADMIN) -->
<section class="hidden" id="settingsSection">
<div class="card">
<div class="card-title"><i class="fa-solid fa-gear"></i> Settings</div>
<!-- Categories -->
<div class="card" style="margin-top:10px;">
<div class="card-title"><i class="fa-solid fa-tags"></i> Categories</div>
<div class="form-row">
<div class="form-group"><label>New Category</label><input class="standard-field" id="newCategory" placeholder="e.g. Fuel"/></div>
<div class="form-group" style="align-self:end;"><button class="btn btn-primary" onclick="addCategory()">Add</button></div>
</div>
<div class="chips" id="categoryChips"></div>
</div>
<!-- Accounts -->
<div class="card" style="margin-top:10px;">
<div class="card-title"><i class="fa-solid fa-wallet"></i> Accounts</div>
<div class="form-row">
<div class="form-group"><label>New Account</label><input class="standard-field" id="newAccount" placeholder="e.g. Cash, Bank"/></div>
<div class="form-group" style="align-self:end;"><button class="btn btn-primary" onclick="addAccount()">Add</button></div>
</div>
<div class="chips" id="accountChips"></div>
</div>
<!-- Users -->
<div class="card" style="margin-top:10px;">
<div class="card-title"><i class="fa-solid fa-users-gear"></i> Users</div>
<div class="form-row">
<div class="form-group"><label>Username</label><input class="standard-field" id="newUsername"/></div>
<div class="form-group"><label>Password</label><input class="standard-field" id="newPassword" type="password"/></div>
<div class="form-group"><label>Role</label>
<select class="standard-field" id="newRole"><option value="user">User</option><option value="admin">Admin</option></select>
</div>
<div class="form-group" style="align-self:end;"><button class="btn btn-primary" onclick="addUser()">Add User</button></div>
</div>
<div style="overflow:auto;margin-top:8px;">
<table>
<thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
<tbody id="usersTableBody"></tbody>
</table>
</div>
</div>
<!-- Data -->
<div class="card" style="margin-top:10px;">
<div class="card-title"><i class="fa-solid fa-database"></i> Data Management</div>
<div class="form-row">
<div class="form-group">
<label>Import Excel (.xlsx)</label>
<input accept=".xlsx" class="standard-field" id="importExcel" onchange="importExcelData(event)" type="file"/>
</div>
</div>
<div style="font-size:12px;color:#6b7280;margin-bottom:8px;">
<strong>Excel Import Instructions:</strong><br/>
            1. Your Excel file should have columns: Date, Category, ID, Vendor, Account, Amount, Description, Type<br/>
            2. Date format should be DD-MM-YYYY<br/>
            3. Type should be either "income" or "expense"<br/>
            4. First row should be headers<br/>
            5. Only admin users can import data
          </div>
<div style="display:flex;gap:8px;margin-top:8px;">
<button class="btn btn-danger" onclick="deleteAllTransactions()"><i class="fa-solid fa-trash"></i> Delete All Transactions</button>
<button class="btn btn-secondary" onclick="backupAllData()"><i class="fa-solid fa-download"></i> Backup All Data</button>
<button class="btn btn-warning" onclick="document.getElementById('restoreFile').click()"><i class="fa-solid fa-upload"></i> Restore Data</button>
<input accept=".json" id="restoreFile" onchange="restoreAllData(event)" style="display:none" type="file"/>
</div>
<div class="muted" style="margin-top:6px;font-size:12px;color:#6b7280;">Import is admin-only and respects your current Category/Account names.</div>
</div>
</div>
</section>
</div>
<section class="card hidden" id="partsSection"><div class="card-title"><i class="fa-solid fa-gears"></i> Parts Management System</div><iframe id="partsFrame" srcdoc="&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Parts Management System - Esthetics Auto&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css&quot;&gt;
    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js&quot;&gt;&lt;/script&gt;
    &lt;style&gt;
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #1a2530);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .company-info {
            text-align: center;
            flex-grow: 1;
        }
        
        .company-info h1 {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .company-info p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-buttons {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            background: linear-gradient(135deg, #2c3e50, #1a2530);
            color: white;
            flex: 1;
            min-width: 200px;
            text-align: center;
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
        }
        
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .search-box button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #2c3e50, #1a2530);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
            cursor: pointer;
            position: sticky;
            top: 0;
        }
        
        th:hover {
            background-color: #1a2530;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f5f9;
        }
        
        .price {
            font-weight: 600;
        }
        
        .original {
            color: #2c3e50;
        }
        
        .aftermarket {
            color: #3498db;
        }
        
        .used {
            color: #e74c3c;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-edit {
            background-color: #3498db;
            color: white;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .summary {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .summary-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .summary-info {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
            text-align: center;
        }
        
        .stock-alert {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .stock-low {
            background-color: #ffeaa7;
            color: #d35400;
        }
        
        .stock-out {
            background-color: #ff7675;
            color: white;
        }
        
        .stock-ok {
            background-color: #55efc4;
            color: #00b894;
        }
        
        .tracking-table {
            font-size: 13px;
        }
        
        .tracking-table th, .tracking-table td {
            padding: 8px;
        }
        
        @media (max-width: 768px) {
            .form-row, .filters {
                flex-direction: column;
            }
            
            .form-group, .filter-group {
                width: 100%;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-buttons {
                justify-content: center;
            }
            
            .navigation {
                flex-direction: column;
            }
            
            .modal-content {
                padding: 15px;
            }
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;header&gt;
            &lt;div class=&quot;company-info&quot;&gt;
                &lt;h1&gt;&lt;i class=&quot;fas fa-cogs&quot;&gt;&lt;/i&gt; Esthetics Auto&lt;/h1&gt;
                &lt;p&gt;Parts Management System&lt;/p&gt;
            &lt;/div&gt;
            &lt;div class=&quot;header-buttons&quot;&gt;
                &lt;button class=&quot;btn btn-success&quot; onclick=&quot;exportToExcel()&quot;&gt;
                    &lt;i class=&quot;fas fa-file-excel&quot;&gt;&lt;/i&gt; Export to Excel
                &lt;/button&gt;
                &lt;button class=&quot;btn btn-danger&quot; onclick=&quot;openPasswordModal()&quot;&gt;
                    &lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt; Clear All Data
                &lt;/button&gt;
            &lt;/div&gt;
        &lt;/header&gt;
        
        &lt;div class=&quot;navigation&quot;&gt;
            &lt;button class=&quot;nav-btn active&quot; onclick=&quot;showPage('partsPage')&quot;&gt;Parts Management&lt;/button&gt;
            &lt;button class=&quot;nav-btn&quot; onclick=&quot;showPage('stockPage')&quot;&gt;Stock Management&lt;/button&gt;
            &lt;button class=&quot;nav-btn&quot; onclick=&quot;showPage('vatPage')&quot;&gt;VAT Management&lt;/button&gt;
        &lt;/div&gt;
        
        &lt;!-- Parts Management Page --&gt;
        &lt;div id=&quot;partsPage&quot; class=&quot;page active&quot;&gt;
            &lt;div class=&quot;card&quot;&gt;
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;pDate&quot;&gt;Date&lt;/label&gt;
                        &lt;input type=&quot;date&quot; id=&quot;pDate&quot; required&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;pCustomerName&quot;&gt;Customer Name&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;pCustomerName&quot; required autocomplete=&quot;off&quot;&gt;
                        &lt;div class=&quot;suggestions&quot; id=&quot;pCustomerSuggestions&quot;&gt;&lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;pVehicle&quot;&gt;Vehicle&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;pVehicle&quot; required autocomplete=&quot;off&quot;&gt;
                        &lt;div class=&quot;suggestions&quot; id=&quot;pVehicleSuggestions&quot;&gt;&lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;pSupplierName&quot;&gt;Supplier Name&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;pSupplierName&quot; required autocomplete=&quot;off&quot;&gt;
                        &lt;div class=&quot;suggestions&quot; id=&quot;pSupplierSuggestions&quot;&gt;&lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;pPartsName&quot;&gt;Parts Name&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;pPartsName&quot; required autocomplete=&quot;off&quot;&gt;
                        &lt;div class=&quot;suggestions&quot; id=&quot;pPartsSuggestions&quot;&gt;&lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;pPartsCategory&quot;&gt;Parts Category&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;pPartsCategory&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;pOriginalPrice&quot;&gt;Original Price (AED)&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;pOriginalPrice&quot; min=&quot;0&quot; step=&quot;0.01&quot; required&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;pAfterMarketPrice&quot;&gt;After Market Price (AED)&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;pAfterMarketPrice&quot; min=&quot;0&quot; step=&quot;0.01&quot; required&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;pUsedPrice&quot;&gt;Used Price (AED)&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;pUsedPrice&quot; min=&quot;0&quot; step=&quot;0.01&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;button class=&quot;btn btn-primary&quot; onclick=&quot;addPart()&quot;&gt;
                        &lt;i class=&quot;fas fa-plus&quot;&gt;&lt;/i&gt; Add Part
                    &lt;/button&gt;
                    &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;addToStockFromPart()&quot;&gt;
                        &lt;i class=&quot;fas fa-boxes&quot;&gt;&lt;/i&gt; Add to Stock
                    &lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;card&quot;&gt;
                &lt;h2&gt;&lt;i class=&quot;fas fa-search&quot;&gt;&lt;/i&gt; Search&lt;/h2&gt;
                &lt;div class=&quot;search-box&quot;&gt;
                    &lt;input type=&quot;text&quot; id=&quot;searchInput&quot; placeholder=&quot;Search by any field...&quot;&gt;
                    &lt;button onclick=&quot;applySearch()&quot;&gt;&lt;i class=&quot;fas fa-search&quot;&gt;&lt;/i&gt; Search&lt;/button&gt;
                &lt;/div&gt;
                
                &lt;h2&gt;&lt;i class=&quot;fas fa-filter&quot;&gt;&lt;/i&gt; Filters&lt;/h2&gt;
                &lt;div class=&quot;filters&quot;&gt;
                    &lt;div class=&quot;filter-group&quot;&gt;
                        &lt;label for=&quot;customerFilter&quot;&gt;Customer Name&lt;/label&gt;
                        &lt;select id=&quot;customerFilter&quot;&gt;
                            &lt;option value=&quot;&quot;&gt;All Customers&lt;/option&gt;
                        &lt;/select&gt;
                    &lt;/div&gt;
                    
                    &lt;div class=&quot;filter-group&quot;&gt;
                        &lt;label for=&quot;vehicleFilter&quot;&gt;Vehicle&lt;/label&gt;
                        &lt;select id=&quot;vehicleFilter&quot;&gt;
                            &lt;option value=&quot;&quot;&gt;All Vehicles&lt;/option&gt;
                        &lt;/select&gt;
                    &lt;/div&gt;
                    
                    &lt;div class=&quot;filter-group&quot;&gt;
                        &lt;label for=&quot;supplierFilter&quot;&gt;Supplier Name&lt;/label&gt;
                        &lt;select id=&quot;supplierFilter&quot;&gt;
                            &lt;option value=&quot;&quot;&gt;All Suppliers&lt;/option&gt;
                        &lt;/select&gt;
                    &lt;/div&gt;
                    
                    &lt;div class=&quot;filter-group&quot;&gt;
                        &lt;label for=&quot;partsFilter&quot;&gt;Parts Name&lt;/label&gt;
                        &lt;select id=&quot;partsFilter&quot;&gt;
                            &lt;option value=&quot;&quot;&gt;All Parts&lt;/option&gt;
                        &lt;/select&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;card&quot;&gt;
                &lt;div class=&quot;table-container&quot;&gt;
                    &lt;table id=&quot;partsTable&quot;&gt;
                        &lt;thead&gt;
                            &lt;tr&gt;
                                &lt;th&gt;Date &lt;i class=&quot;fas fa-sort&quot;&gt;&lt;/i&gt;&lt;/th&gt;
                                &lt;th&gt;Customer Name &lt;i class=&quot;fas fa-sort&quot;&gt;&lt;/i&gt;&lt;/th&gt;
                                &lt;th&gt;Vehicle &lt;i class=&quot;fas fa-sort&quot;&gt;&lt;/i&gt;&lt;/th&gt;
                                &lt;th&gt;Supplier Name &lt;i class=&quot;fas fa-sort&quot;&gt;&lt;/i&gt;&lt;/th&gt;
                                &lt;th&gt;Parts Name &lt;i class=&quot;fas fa-sort&quot;&gt;&lt;/i&gt;&lt;/th&gt;
                                &lt;th&gt;Parts Category &lt;i class=&quot;fas fa-sort&quot;&gt;&lt;/i&gt;&lt;/th&gt;
                                &lt;th&gt;Original Price &lt;i class=&quot;fas fa-sort&quot;&gt;&lt;/i&gt;&lt;/th&gt;
                                &lt;th&gt;After Market Price &lt;i class=&quot;fas fa-sort&quot;&gt;&lt;/i&gt;&lt;/th&gt;
                                &lt;th&gt;Used Price &lt;i class=&quot;fas fa-sort&quot;&gt;&lt;/i&gt;&lt;/th&gt;
                                &lt;th&gt;Actions&lt;/th&gt;
                            &lt;/tr&gt;
                        &lt;/thead&gt;
                        &lt;tbody id=&quot;tableBody&quot;&gt;
                            &lt;!-- Table data will be populated here --&gt;
                        &lt;/tbody&gt;
                    &lt;/table&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;summary&quot;&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Total Parts&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;totalParts&quot;&gt;0&lt;/div&gt;
                    &lt;div class=&quot;summary-info&quot; id=&quot;totalPartsInfo&quot;&gt;of 0 total&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Avg. Original Price&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;avgOriginal&quot;&gt;AED 0.00&lt;/div&gt;
                    &lt;div class=&quot;summary-info&quot; id=&quot;avgOriginalInfo&quot;&gt;of AED 0.00&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Avg. After Market&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;avgAfterMarket&quot;&gt;AED 0.00&lt;/div&gt;
                    &lt;div class=&quot;summary-info&quot; id=&quot;avgAfterMarketInfo&quot;&gt;of AED 0.00&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Avg. Used Price&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;avgUsed&quot;&gt;AED 0.00&lt;/div&gt;
                    &lt;div class=&quot;summary-info&quot; id=&quot;avgUsedInfo&quot;&gt;of AED 0.00&lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;!-- Stock Management Page --&gt;
        &lt;div id=&quot;stockPage&quot; class=&quot;page&quot;&gt;
            &lt;div class=&quot;card&quot;&gt;
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;sPartNumber&quot;&gt;Part Number&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;sPartNumber&quot; required&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;sPartName&quot;&gt;Part Name&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;sPartName&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;sDescription&quot;&gt;Description&lt;/label&gt;
                        &lt;textarea id=&quot;sDescription&quot; rows=&quot;2&quot;&gt;&lt;/textarea&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;sCategory&quot;&gt;Category&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;sCategory&quot; required&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;sQuantity&quot;&gt;Quantity&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;sQuantity&quot; min=&quot;0&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;sUnitPrice&quot;&gt;Unit Price (AED)&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;sUnitPrice&quot; min=&quot;0&quot; step=&quot;0.01&quot; required&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;sSupplier&quot;&gt;Supplier&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;sSupplier&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;sMinStock&quot;&gt;Minimum Stock Level&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;sMinStock&quot; min=&quot;0&quot; value=&quot;5&quot;&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;sMaxStock&quot;&gt;Maximum Stock Level&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;sMaxStock&quot; min=&quot;0&quot; value=&quot;50&quot;&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;button class=&quot;btn btn-primary&quot; onclick=&quot;addStockItem()&quot;&gt;
                        &lt;i class=&quot;fas fa-plus&quot;&gt;&lt;/i&gt; Add Stock Item
                    &lt;/button&gt;
                    &lt;button class=&quot;btn btn-warning&quot; onclick=&quot;updateStockItem()&quot;&gt;
                        &lt;i class=&quot;fas fa-edit&quot;&gt;&lt;/i&gt; Update Stock
                    &lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;card&quot;&gt;
                &lt;h2&gt;&lt;i class=&quot;fas fa-search&quot;&gt;&lt;/i&gt; Search Stock&lt;/h2&gt;
                &lt;div class=&quot;search-box&quot;&gt;
                    &lt;input type=&quot;text&quot; id=&quot;stockSearchInput&quot; placeholder=&quot;Search stock...&quot;&gt;
                    &lt;button onclick=&quot;applyStockSearch()&quot;&gt;&lt;i class=&quot;fas fa-search&quot;&gt;&lt;/i&gt; Search&lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;card&quot;&gt;
                &lt;div class=&quot;table-container&quot;&gt;
                    &lt;table id=&quot;stockTable&quot;&gt;
                        &lt;thead&gt;
                            &lt;tr&gt;
                                &lt;th&gt;Part Number&lt;/th&gt;
                                &lt;th&gt;Part Name&lt;/th&gt;
                                &lt;th&gt;Description&lt;/th&gt;
                                &lt;th&gt;Category&lt;/th&gt;
                                &lt;th&gt;Quantity&lt;/th&gt;
                                &lt;th&gt;Unit Price (AED)&lt;/th&gt;
                                &lt;th&gt;Total Value (AED)&lt;/th&gt;
                                &lt;th&gt;Supplier&lt;/th&gt;
                                &lt;th&gt;Stock Status&lt;/th&gt;
                                &lt;th&gt;Last Updated&lt;/th&gt;
                                &lt;th&gt;Actions&lt;/th&gt;
                            &lt;/tr&gt;
                        &lt;/thead&gt;
                        &lt;tbody id=&quot;stockTableBody&quot;&gt;
                            &lt;!-- Stock data will be populated here --&gt;
                        &lt;/tbody&gt;
                    &lt;/table&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;summary&quot;&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Total Items&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;totalItems&quot;&gt;0&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Total Stock Value&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;totalStockValue&quot;&gt;AED 0.00&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Low Stock Items&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;lowStockItems&quot;&gt;0&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Out of Stock&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;outOfStock&quot;&gt;0&lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;!-- Stock Tracking Section --&gt;
            &lt;div class=&quot;card&quot;&gt;
                &lt;h2&gt;&lt;i class=&quot;fas fa-history&quot;&gt;&lt;/i&gt; Stock Tracking&lt;/h2&gt;
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;trackPart&quot;&gt;Select Part to Track&lt;/label&gt;
                        &lt;select id=&quot;trackPart&quot; onchange=&quot;showStockHistory()&quot;&gt;
                            &lt;option value=&quot;&quot;&gt;Select a part&lt;/option&gt;
                        &lt;/select&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div id=&quot;stockHistoryContainer&quot;&gt;
                    &lt;h3&gt;Stock History for: &lt;span id=&quot;selectedPartName&quot;&gt;-&lt;/span&gt;&lt;/h3&gt;
                    &lt;div class=&quot;table-container&quot;&gt;
                        &lt;table class=&quot;tracking-table&quot;&gt;
                            &lt;thead&gt;
                                &lt;tr&gt;
                                    &lt;th&gt;Date&lt;/th&gt;
                                    &lt;th&gt;Type&lt;/th&gt;
                                    &lt;th&gt;Quantity Change&lt;/th&gt;
                                    &lt;th&gt;New Quantity&lt;/th&gt;
                                    &lt;th&gt;Reference&lt;/th&gt;
                                    &lt;th&gt;User&lt;/th&gt;
                                &lt;/tr&gt;
                            &lt;/thead&gt;
                            &lt;tbody id=&quot;stockHistoryBody&quot;&gt;
                                &lt;!-- Stock history will be populated here --&gt;
                            &lt;/tbody&gt;
                        &lt;/table&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;!-- VAT Management Page --&gt;
        &lt;div id=&quot;vatPage&quot; class=&quot;page&quot;&gt;
            &lt;div class=&quot;card&quot;&gt;
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vDate&quot;&gt;Date&lt;/label&gt;
                        &lt;input type=&quot;date&quot; id=&quot;vDate&quot; required&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vInvoiceNumber&quot;&gt;Invoice #&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;vInvoiceNumber&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vPartNumber&quot;&gt;Parts #&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;vPartNumber&quot; required&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vDescription&quot;&gt;Description&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;vDescription&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vQuantity&quot;&gt;QTY&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;vQuantity&quot; min=&quot;1&quot; required&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vUnitPrice&quot;&gt;Unit Price (AED)&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;vUnitPrice&quot; min=&quot;0&quot; step=&quot;0.01&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vSupplier&quot;&gt;Supplier&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;vSupplier&quot; required&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vVehicle&quot;&gt;Vehicle&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;vVehicle&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vPlateNumber&quot;&gt;Plate #&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;vPlateNumber&quot;&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vCustomer&quot;&gt;Customer&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;vCustomer&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vTrnNumber&quot;&gt;INV# TRN Number&lt;/label&gt;
                        &lt;input type=&quot;text&quot; id=&quot;vTrnNumber&quot; required&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;button class=&quot;btn btn-primary&quot; onclick=&quot;addVatRecord()&quot;&gt;
                        &lt;i class=&quot;fas fa-plus&quot;&gt;&lt;/i&gt; Add VAT Record
                    &lt;/button&gt;
                    &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;calculateVat()&quot;&gt;
                        &lt;i class=&quot;fas fa-calculator&quot;&gt;&lt;/i&gt; Calculate VAT
                    &lt;/button&gt;
                &lt;/div&gt;
                
                &lt;div class=&quot;form-row&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vVatAmount&quot;&gt;VAT Amount (AED)&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;vVatAmount&quot; readonly&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vAmountWithoutVat&quot;&gt;Amount Without VAT (AED)&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;vAmountWithoutVat&quot; readonly&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label for=&quot;vAmountWithVat&quot;&gt;Amount With VAT (AED)&lt;/label&gt;
                        &lt;input type=&quot;number&quot; id=&quot;vAmountWithVat&quot; readonly&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;card&quot;&gt;
                &lt;h2&gt;&lt;i class=&quot;fas fa-search&quot;&gt;&lt;/i&gt; Search VAT Records&lt;/h2&gt;
                &lt;div class=&quot;search-box&quot;&gt;
                    &lt;input type=&quot;text&quot; id=&quot;vatSearchInput&quot; placeholder=&quot;Search VAT records...&quot;&gt;
                    &lt;button onclick=&quot;applyVatSearch()&quot;&gt;&lt;i class=&quot;fas fa-search&quot;&gt;&lt;/i&gt; Search&lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;card&quot;&gt;
                &lt;div class=&quot;table-container&quot;&gt;
                    &lt;table id=&quot;vatTable&quot;&gt;
                        &lt;thead&gt;
                            &lt;tr&gt;
                                &lt;th&gt;Date&lt;/th&gt;
                                &lt;th&gt;Invoice #&lt;/th&gt;
                                &lt;th&gt;Parts #&lt;/th&gt;
                                &lt;th&gt;Description&lt;/th&gt;
                                &lt;th&gt;QTY&lt;/th&gt;
                                &lt;th&gt;Unit Price (AED)&lt;/th&gt;
                                &lt;th&gt;VAT 5%&lt;/th&gt;
                                &lt;th&gt;VAT Amount (AED)&lt;/th&gt;
                                &lt;th&gt;Amount Without VAT (AED)&lt;/th&gt;
                                &lt;th&gt;Amount With VAT (AED)&lt;/th&gt;
                                &lt;th&gt;Supplier&lt;/th&gt;
                                &lt;th&gt;Vehicle&lt;/th&gt;
                                &lt;th&gt;Plate #&lt;/th&gt;
                                &lt;th&gt;Customer&lt;/th&gt;
                                &lt;th&gt;INV# TRN Number&lt;/th&gt;
                                &lt;th&gt;Actions&lt;/th&gt;
                            &lt;/tr&gt;
                        &lt;/thead&gt;
                        &lt;tbody id=&quot;vatTableBody&quot;&gt;
                            &lt;!-- VAT data will be populated here --&gt;
                        &lt;/tbody&gt;
                    &lt;/table&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;summary&quot;&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Total VAT Amount&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;totalVatAmount&quot;&gt;AED 0.00&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Total Without VAT&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;totalWithoutVat&quot;&gt;AED 0.00&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Total With VAT&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;totalWithVat&quot;&gt;AED 0.00&lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;summary-card&quot;&gt;
                    &lt;h3&gt;Total Invoices&lt;/h3&gt;
                    &lt;div class=&quot;value&quot; id=&quot;totalInvoices&quot;&gt;0&lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Password Modal --&gt;
    &lt;div id=&quot;passwordModal&quot; class=&quot;modal&quot;&gt;
        &lt;div class=&quot;modal-content&quot;&gt;
            &lt;div class=&quot;modal-header&quot;&gt;
                &lt;h2&gt;Clear All Data&lt;/h2&gt;
                &lt;span class=&quot;close&quot; onclick=&quot;closePasswordModal()&quot;&gt;&amp;times;&lt;/span&gt;
            &lt;/div&gt;
            &lt;p&gt;Please enter the password to clear all data:&lt;/p&gt;
            &lt;input type=&quot;password&quot; id=&quot;passwordInput&quot; class=&quot;password-input&quot; placeholder=&quot;Enter password&quot;&gt;
            &lt;div class=&quot;form-row&quot;&gt;
                &lt;button class=&quot;btn btn-danger&quot; onclick=&quot;clearAllData()&quot;&gt;
                    &lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt; Confirm Clear All Data
                &lt;/button&gt;
                &lt;button type=&quot;button&quot; class=&quot;btn&quot; onclick=&quot;closePasswordModal()&quot; style=&quot;background: #95a5a6; color: white;&quot;&gt;
                    &lt;i class=&quot;fas fa-times&quot;&gt;&lt;/i&gt; Cancel
                &lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Stock Update Modal --&gt;
    &lt;div id=&quot;stockUpdateModal&quot; class=&quot;modal&quot;&gt;
        &lt;div class=&quot;modal-content&quot;&gt;
            &lt;div class=&quot;modal-header&quot;&gt;
                &lt;h2&gt;Update Stock Item&lt;/h2&gt;
                &lt;span class=&quot;close&quot; onclick=&quot;closeStockUpdateModal()&quot;&gt;&amp;times;&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-row&quot;&gt;
                &lt;div class=&quot;form-group&quot;&gt;
                    &lt;label for=&quot;updatePartNumber&quot;&gt;Part Number&lt;/label&gt;
                    &lt;input type=&quot;text&quot; id=&quot;updatePartNumber&quot; readonly&gt;
                &lt;/div&gt;
                &lt;div class=&quot;form-group&quot;&gt;
                    &lt;label for=&quot;updatePartName&quot;&gt;Part Name&lt;/label&gt;
                    &lt;input type=&quot;text&quot; id=&quot;updatePartName&quot; readonly&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;form-row&quot;&gt;
                &lt;div class=&quot;form-group&quot;&gt;
                    &lt;label for=&quot;updateType&quot;&gt;Update Type&lt;/label&gt;
                    &lt;select id=&quot;updateType&quot;&gt;
                        &lt;option value=&quot;add&quot;&gt;Add Stock&lt;/option&gt;
                        &lt;option value=&quot;remove&quot;&gt;Remove Stock&lt;/option&gt;
                        &lt;option value=&quot;set&quot;&gt;Set Stock Level&lt;/option&gt;
                    &lt;/select&gt;
                &lt;/div&gt;
                &lt;div class=&quot;form-group&quot;&gt;
                    &lt;label for=&quot;updateQuantity&quot;&gt;Quantity&lt;/label&gt;
                    &lt;input type=&quot;number&quot; id=&quot;updateQuantity&quot; min=&quot;1&quot; value=&quot;1&quot;&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;form-row&quot;&gt;
                &lt;div class=&quot;form-group&quot;&gt;
                    &lt;label for=&quot;updateReason&quot;&gt;Reason&lt;/label&gt;
                    &lt;input type=&quot;text&quot; id=&quot;updateReason&quot; placeholder=&quot;Sale, restock, etc.&quot;&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;form-row&quot;&gt;
                &lt;button class=&quot;btn btn-primary&quot; onclick=&quot;confirmStockUpdate()&quot;&gt;
                    &lt;i class=&quot;fas fa-save&quot;&gt;&lt;/i&gt; Update Stock
                &lt;/button&gt;
                &lt;button class=&quot;btn btn-secondary&quot; onclick=&quot;closeStockUpdateModal()&quot;&gt;
                    &lt;i class=&quot;fas fa-times&quot;&gt;&lt;/i&gt; Cancel
                &lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;footer&gt;
        &lt;p&gt;© 2023 Esthetics Auto. All rights reserved BY Qasim Aziz&lt;/p&gt;
    &lt;/footer&gt;

    &lt;script&gt;
        // Data storage
        let partsData = JSON.parse(localStorage.getItem('partsData')) || [];
        let stockData = JSON.parse(localStorage.getItem('stockData')) || [];
        let vatData = JSON.parse(localStorage.getItem('vatData')) || [];
        let stockHistory = JSON.parse(localStorage.getItem('stockHistory')) || [];
        const PASSWORD = &quot;Snooker&quot;; // Password for clearing data
        
        // DOM elements
        const tableBody = document.getElementById('tableBody');
        const stockTableBody = document.getElementById('stockTableBody');
        const vatTableBody = document.getElementById('vatTableBody');
        const passwordModal = document.getElementById('passwordModal');
        const stockUpdateModal = document.getElementById('stockUpdateModal');
        
        // Filter dropdowns
        const customerFilter = document.getElementById('customerFilter');
        const vehicleFilter = document.getElementById('vehicleFilter');
        const supplierFilter = document.getElementById('supplierFilter');
        const partsFilter = document.getElementById('partsFilter');
        const searchInput = document.getElementById('searchInput');
        const stockSearchInput = document.getElementById('stockSearchInput');
        const vatSearchInput = document.getElementById('vatSearchInput');
        const trackPart = document.getElementById('trackPart');
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date for all date fields
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pDate').value = today;
            document.getElementById('vDate').value = today;
            
            renderPartsTable();
            renderStockTable();
            renderVatTable();
            updateFilters();
            updatePartsSummary();
            updateStockSummary();
            updateVatSummary();
            updateTrackPartDropdown();
            
            // Add event listeners for filters
            customerFilter.addEventListener('change', applyFilters);
            vehicleFilter.addEventListener('change', applyFilters);
            supplierFilter.addEventListener('change', applyFilters);
            partsFilter.addEventListener('change', applyFilters);
            
            // Search on Enter key
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applySearch();
                }
            });
            
            stockSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyStockSearch();
                }
            });
            
            vatSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyVatSearch();
                }
            });
            
            // Add sample data if empty
            if (partsData.length === 0) addSamplePartsData();
            if (stockData.length === 0) addSampleStockData();
            if (vatData.length === 0) addSampleVatData();
        });
        
        // Show page function
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page =&gt; {
                page.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.nav-btn').forEach(btn =&gt; {
                btn.classList.remove('active');
            });
            
            // Show the selected page and activate its button
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            
            // Update tracking dropdown if on stock page
            if (pageId === 'stockPage') {
                updateTrackPartDropdown();
            }
        }
        
        // Add new part
        function addPart() {
            const part = {
              get: (k, fallback) => {
                try {
                  if (!window.localStorage) return fallback;
                  const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback;
                } catch (e) { console.error('LS.get error', k, e); return fallback; }
              },
              set: (k, v) => {
                try {
                  if (!window.localStorage) return;
                  localStorage.setItem(k, JSON.stringify(v));
                } catch (e) {
                  console.error('LS.set error', k, e);
                  alert('Storage error: Unable to save data locally. Please free up storage or try a smaller dataset.');
                }
              }
            // Validate required fields
            if (!part.date || !part.customerName || !part.vehicle || !part.supplierName || 
                !part.partsName || !part.partsCategory || isNaN(part.originalPrice) || 
                isNaN(part.afterMarketPrice) || isNaN(part.usedPrice)) {
                alert('Please fill all required fields with valid values');
                return;
            }
            
            partsData.push(part);
            localStorage.setItem('partsData', JSON.stringify(partsData));
            
            // Clear form
            document.getElementById('pCustomerName').value = '';
            document.getElementById('pVehicle').value = '';
            document.getElementById('pSupplierName').value = '';
            document.getElementById('pPartsName').value = '';
            document.getElementById('pPartsCategory').value = '';
            document.getElementById('pOriginalPrice').value = '';
            document.getElementById('pAfterMarketPrice').value = '';
            document.getElementById('pUsedPrice').value = '';
            
            // Update UI
            renderPartsTable();
            updateFilters();
            updatePartsSummary();
            
            alert('Part added successfully!');
        }
        
        // Add to stock from part form
        function addToStockFromPart() {
            const partName = document.getElementById('pPartsName').value;
            const category = document.getElementById('pPartsCategory').value;
            const supplier = document.getElementById('pSupplierName').value;
            const price = document.getElementById('pOriginalPrice').value;
            
            if (!partName || !category || !supplier || !price) {
                alert('Please fill in the part details first');
                return;
            }
            
            // Generate part number
            const partNumber = generatePartNumber(partName, category);
            
            // Pre-fill stock form
            document.getElementById('sPartNumber').value = partNumber;
            document.getElementById('sPartName').value = partName;
            document.getElementById('sCategory').value = category;
            document.getElementById('sSupplier').value = supplier;
            document.getElementById('sUnitPrice').value = price;
            
            // Switch to stock page
            showPage('stockPage');
            
            alert('Part details transferred to stock form. Please complete the stock information.');
        }
        
        // Generate part number from name and category
        function generatePartNumber(partName, category) {
            const categoryAbbr = category.substring(0, 3).toUpperCase();
            const nameAbbr = partName.split(' ')
                .map(word =&gt; word.substring(0, 1).toUpperCase())
                .join('')
                .substring(0, 3);
            
            return `${categoryAbbr}-${nameAbbr}-${Math.floor(1000 + Math.random() * 9000)}`;
        }
        
        // Add stock item
        function addStockItem() {
            const item = {
                partNumber: document.getElementById('sPartNumber').value,
                partName: document.getElementById('sPartName').value,
                description: document.getElementById('sDescription').value,
                category: document.getElementById('sCategory').value,
                quantity: parseInt(document.getElementById('sQuantity').value) || 0,
                unitPrice: parseFloat(document.getElementById('sUnitPrice').value),
                supplier: document.getElementById('sSupplier').value,
                minStock: parseInt(document.getElementById('sMinStock').value) || 5,
                maxStock: parseInt(document.getElementById('sMaxStock').value) || 50,
                lastUpdated: new Date().toISOString().split('T')[0]
            };
            
            // Validate required fields
            if (!item.partNumber || !item.partName || !item.category || 
                isNaN(item.unitPrice) || !item.supplier) {
                alert('Please fill all required fields with valid values');
                return;
            }
            
            // Check if part number already exists
            const existingIndex = stockData.findIndex(i =&gt; i.partNumber === item.partNumber);
            if (existingIndex &gt;= 0) {
                // Update existing item
                stockData[existingIndex] = item;
                
                // Add to history
                addStockHistory(item.partNumber, 'update', item.quantity, `Manual update to ${item.quantity}`);
            } else {
                // Add new item
                stockData.push(item);
                
                // Add to history
                addStockHistory(item.partNumber, 'add', item.quantity, `Initial stock added: ${item.quantity}`);
            }
            
            localStorage.setItem('stockData', JSON.stringify(stockData));
            localStorage.setItem('stockHistory', JSON.stringify(stockHistory));
            
            // Clear form
            document.getElementById('sPartNumber').value = '';
            document.getElementById('sPartName').value = '';
            document.getElementById('sDescription').value = '';
            document.getElementById('sCategory').value = '';
            document.getElementById('sQuantity').value = '';
            document.getElementById('sUnitPrice').value = '';
            document.getElementById('sSupplier').value = '';
            
            // Update UI
            renderStockTable();
            updateStockSummary();
            updateTrackPartDropdown();
            
            alert('Stock item saved successfully!');
        }
        
        // Update stock item
        function updateStockItem() {
            const partNumber = document.getElementById('sPartNumber').value;
            
            if (!partNumber) {
                alert('Please enter a part number');
                return;
            }
            
            // Find the item
            const itemIndex = stockData.findIndex(item =&gt; item.partNumber === partNumber);
            
            if (itemIndex === -1) {
                alert('Part number not found in stock');
                return;
            }
            
            // Populate update modal
            const item = stockData[itemIndex];
            document.getElementById('updatePartNumber').value = item.partNumber;
            document.getElementById('updatePartName').value = item.partName;
            document.getElementById('updateQuantity').value = 1;
            document.getElementById('updateReason').value = '';
            
            // Show modal
            stockUpdateModal.style.display = 'flex';
        }
        
        // Confirm stock update
        function confirmStockUpdate() {
            const partNumber = document.getElementById('updatePartNumber').value;
            const updateType = document.getElementById('updateType').value;
            const quantity = parseInt(document.getElementById('updateQuantity').value);
            const reason = document.getElementById('updateReason').value;
            
            if (isNaN(quantity) || quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            // Find the item
            const itemIndex = stockData.findIndex(item =&gt; item.partNumber === partNumber);
            
            if (itemIndex === -1) {
                alert('Part number not found in stock');
                return;
            }
            
            const item = stockData[itemIndex];
            let newQuantity = item.quantity;
            let historyAction = '';
            
            // Apply update based on type
            switch (updateType) {
                case 'add':
                    newQuantity += quantity;
                    historyAction = `Added ${quantity} units. Reason: ${reason || 'No reason provided'}`;
                    break;
                case 'remove':
                    if (quantity &gt; item.quantity) {
                        alert('Cannot remove more than available stock');
                        return;
                    }
                    newQuantity -= quantity;
                    historyAction = `Removed ${quantity} units. Reason: ${reason || 'No reason provided'}`;
                    break;
                case 'set':
                    newQuantity = quantity;
                    historyAction = `Stock set to ${quantity} units. Reason: ${reason || 'No reason provided'}`;
                    break;
            }
            
            // Update item
            stockData[itemIndex].quantity = newQuantity;
            stockData[itemIndex].lastUpdated = new Date().toISOString().split('T')[0];
            
            // Add to history
            addStockHistory(partNumber, updateType, newQuantity, historyAction);
            
            localStorage.setItem('stockData', JSON.stringify(stockData));
            localStorage.setItem('stockHistory', JSON.stringify(stockHistory));
            
            // Close modal and update UI
            closeStockUpdateModal();
            renderStockTable();
            updateStockSummary();
            
            alert('Stock updated successfully!');
        }
        
        // Add stock history record
        function addStockHistory(partNumber, action, newQuantity, details) {
            const historyRecord = {
                partNumber: partNumber,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString(),
                action: action,
                quantityChange: action === 'add' ? '+' + (newQuantity - (getPreviousQuantity(partNumber) || 0)) : 
                            action === 'remove' ? '-' + (getPreviousQuantity(partNumber) - newQuantity) : 'Set',
                newQuantity: newQuantity,
                details: details,
                user: 'Admin' // In a real system, this would be the logged-in user
            };
            
            stockHistory.push(historyRecord);
        }
        
        // Get previous quantity for a part
        function getPreviousQuantity(partNumber) {
            const item = stockData.find(item =&gt; item.partNumber === partNumber);
            return item ? item.quantity : 0;
        }
        
        // Show stock history for selected part
        function showStockHistory() {
            const partNumber = trackPart.value;
            
            if (!partNumber) {
                document.getElementById('stockHistoryBody').innerHTML = '';
                document.getElementById('selectedPartName').textContent = '-';
                return;
            }
            
            // Find the part name
            const item = stockData.find(item =&gt; item.partNumber === partNumber);
            document.getElementById('selectedPartName').textContent = item ? item.partName : 'Unknown';
            
            // Filter history for this part
            const partHistory = stockHistory.filter(record =&gt; record.partNumber === partNumber);
            
            // Display history
            const historyBody = document.getElementById('stockHistoryBody');
            historyBody.innerHTML = '';
            
            if (partHistory.length === 0) {
                historyBody.innerHTML = '&lt;tr&gt;&lt;td colspan=&quot;6&quot; style=&quot;text-align: center;&quot;&gt;No history found for this part&lt;/td&gt;&lt;/tr&gt;';
                return;
            }
            
            // Sort by date and time (newest first)
            partHistory.sort((a, b) =&gt; new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
            
            partHistory.forEach(record =&gt; {
                const row = document.createElement('tr');
                row.innerHTML = `
                    &lt;td&gt;${record.date}&lt;/td&gt;
                    &lt;td&gt;${record.action}&lt;/td&gt;
                    &lt;td&gt;${record.quantityChange}&lt;/td&gt;
                    &lt;td&gt;${record.newQuantity}&lt;/td&gt;
                    &lt;td&gt;${record.details}&lt;/td&gt;
                    &lt;td&gt;${record.user}&lt;/td&gt;
                `;
                historyBody.appendChild(row);
            });
        }
        
        // Update track part dropdown
        function updateTrackPartDropdown() {
            trackPart.innerHTML = '&lt;option value=&quot;&quot;&gt;Select a part&lt;/option&gt;';
            
            stockData.forEach(item =&gt; {
                const option = document.createElement('option');
                option.value = item.partNumber;
                option.textContent = `${item.partNumber} - ${item.partName}`;
                trackPart.appendChild(option);
            });
        }
        
        // Close stock update modal
        function closeStockUpdateModal() {
            stockUpdateModal.style.display = 'none';
        }
        
        // Add VAT record
        function addVatRecord() {
            const unitPrice = parseFloat(document.getElementById('vUnitPrice').value);
            const quantity = parseInt(document.getElementById('vQuantity').value);
            const amountWithoutVat = unitPrice * quantity;
            const vatAmount = amountWithoutVat * 0.05;
            const amountWithVat = amountWithoutVat + vatAmount;
            
            const record = {
                date: document.getElementById('vDate').value,
                invoiceNumber: document.getElementById('vInvoiceNumber').value,
                partNumber: document.getElementById('vPartNumber').value,
                description: document.getElementById('vDescription').value,
                quantity: quantity,
                unitPrice: unitPrice,
                vatAmount: vatAmount,
                amountWithoutVat: amountWithoutVat,
                amountWithVat: amountWithVat,
                supplier: document.getElementById('vSupplier').value,
                vehicle: document.getElementById('vVehicle').value,
                plateNumber: document.getElementById('vPlateNumber').value,
                customer: document.getElementById('vCustomer').value,
                trnNumber: document.getElementById('vTrnNumber').value
            };
            
            // Validate required fields
            if (!record.date || !record.invoiceNumber || !record.partNumber || !record.description || 
                isNaN(record.quantity) || isNaN(record.unitPrice) || !record.supplier || 
                !record.vehicle || !record.customer || !record.trnNumber) {
                alert('Please fill all required fields with valid values');
                return;
            }
            
            vatData.push(record);
            localStorage.setItem('vatData', JSON.stringify(vatData));
            
            // Clear form
            document.getElementById('vInvoiceNumber').value = '';
            document.getElementById('vPartNumber').value = '';
            document.getElementById('vDescription').value = '';
            document.getElementById('vQuantity').value = '';
            document.getElementById('vUnitPrice').value = '';
            document.getElementById('vSupplier').value = '';
            document.getElementById('vVehicle').value = '';
            document.getElementById('vPlateNumber').value = '';
            document.getElementById('vCustomer').value = '';
            document.getElementById('vTrnNumber').value = '';
            document.getElementById('vVatAmount').value = '';
            document.getElementById('vAmountWithoutVat').value = '';
            document.getElementById('vAmountWithVat').value = '';
            
            // Update UI
            renderVatTable();
            updateVatSummary();
            
            alert('VAT record added successfully!');
        }
        
        // Calculate VAT
        function calculateVat() {
            const unitPrice = parseFloat(document.getElementById('vUnitPrice').value);
            const quantity = parseInt(document.getElementById('vQuantity').value);
            
            if (isNaN(unitPrice) || isNaN(quantity)) {
                alert('Please enter unit price and quantity first');
                return;
            }
            
            const amountWithoutVat = unitPrice * quantity;
            const vatAmount = amountWithoutVat * 0.05;
            const amountWithVat = amountWithoutVat + vatAmount;
            
            document.getElementById('vVatAmount').value = vatAmount.toFixed(2);
            document.getElementById('vAmountWithoutVat').value = amountWithoutVat.toFixed(2);
            document.getElementById('vAmountWithVat').value = amountWithVat.toFixed(2);
        }
        
        // Delete part
        function deletePart(index) {
            if (confirm('Are you sure you want to delete this part?')) {
                partsData.splice(index, 1);
                localStorage.setItem('partsData', JSON.stringify(partsData));
                renderPartsTable();
                updateFilters();
                updatePartsSummary();
            }
        }
        
        // Delete stock item
        function deleteStockItem(index) {
            if (confirm('Are you sure you want to delete this stock item?')) {
                const partNumber = stockData[index].partNumber;
                stockData.splice(index, 1);
                
                // Add to history
                addStockHistory(partNumber, 'delete', 0, 'Item deleted from stock');
                
                localStorage.setItem('stockData', JSON.stringify(stockData));
                localStorage.setItem('stockHistory', JSON.stringify(stockHistory));
                renderStockTable();
                updateStockSummary();
                updateTrackPartDropdown();
            }
        }
        
        // Delete VAT record
        function deleteVatRecord(index) {
            if (confirm('Are you sure you want to delete this VAT record?')) {
                vatData.splice(index, 1);
                localStorage.setItem('vatData', JSON.stringify(vatData));
                renderVatTable();
                updateVatSummary();
            }
        }
        
        // Get filtered data based on current filters and search
        function getFilteredData() {
            const customerValue = customerFilter.value;
            const vehicleValue = vehicleFilter.value;
            const supplierValue = supplierFilter.value;
            const partsValue = partsFilter.value;
            const searchValue = searchInput.value.toLowerCase();
            
            // If no filters or search applied, return all data
            if (!customerValue &amp;&amp; !vehicleValue &amp;&amp; !supplierValue &amp;&amp; !partsValue &amp;&amp; !searchValue) {
                return partsData;
            }
            
            return partsData.filter(part =&gt; {
                // Check filters
                const customerMatch = !customerValue || part.customerName === customerValue;
                const vehicleMatch = !vehicleValue || part.vehicle === vehicleValue;
                const supplierMatch = !supplierValue || part.supplierName === supplierValue;
                const partsMatch = !partsValue || part.partsName === partsValue;
                
                // Check search
                const searchMatch = !searchValue || 
                    part.date.toLowerCase().includes(searchValue) ||
                    part.customerName.toLowerCase().includes(searchValue) ||
                    part.vehicle.toLowerCase().includes(searchValue) ||
                    part.supplierName.toLowerCase().includes(searchValue) ||
                    part.partsName.toLowerCase().includes(searchValue) ||
                    part.partsCategory.toLowerCase().includes(searchValue) ||
                    part.originalPrice.toString().includes(searchValue) ||
                    part.afterMarketPrice.toString().includes(searchValue) ||
                    part.usedPrice.toString().includes(searchValue);
                
                return customerMatch &amp;&amp; vehicleMatch &amp;&amp; supplierMatch &amp;&amp; partsMatch &amp;&amp; searchMatch;
            });
        }
        
        // Render table with data
        function renderPartsTable() {
            tableBody.innerHTML = '';
            
            if (partsData.length === 0) {
                tableBody.innerHTML = '&lt;tr&gt;&lt;td colspan=&quot;10&quot; style=&quot;text-align: center;&quot;&gt;No data available. Please add some parts.&lt;/td&gt;&lt;/tr&gt;';
                return;
            }
            
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = '&lt;tr&gt;&lt;td colspan=&quot;10&quot; style=&quot;text-align: center;&quot;&gt;No matching records found.&lt;/td&gt;&lt;/tr&gt;';
                return;
            }
            
            filteredData.forEach((part, index) =&gt; {
                const row = document.createElement('tr');
                row.innerHTML = `
                    &lt;td&gt;${part.date}&lt;/td&gt;
                    &lt;td&gt;${part.customerName}&lt;/td&gt;
                    &lt;td&gt;${part.vehicle}&lt;/td&gt;
                    &lt;td&gt;${part.supplierName}&lt;/td&gt;
                    &lt;td&gt;${part.partsName}&lt;/td&gt;
                    &lt;td&gt;${part.partsCategory}&lt;/td&gt;
                    &lt;td class=&quot;price original&quot;&gt;AED ${part.originalPrice.toFixed(2)}&lt;/td&gt;
                    &lt;td class=&quot;price aftermarket&quot;&gt;AED ${part.afterMarketPrice.toFixed(2)}&lt;/td&gt;
                    &lt;td class=&quot;price used&quot;&gt;AED ${part.usedPrice.toFixed(2)}&lt;/td&gt;
                    &lt;td class=&quot;action-buttons&quot;&gt;
                        &lt;button class=&quot;action-btn btn-delete&quot; onclick=&quot;deletePart(${index})&quot;&gt;
                            &lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt; Delete
                        &lt;/button&gt;
                    &lt;/td&gt;
                `;
                tableBody.appendChild(row);
            });
            
            // Update summary with filtered data
            updatePartsSummary(filteredData);
        }
        
        // Render stock table
        function renderStockTable() {
            stockTableBody.innerHTML = '';
            
            if (stockData.length === 0) {
                stockTableBody.innerHTML = '&lt;tr&gt;&lt;td colspan=&quot;11&quot; style=&quot;text-align: center;&quot;&gt;No stock data available.&lt;/td&gt;&lt;/tr&gt;';
                return;
            }
            
            const searchValue = stockSearchInput.value.toLowerCase();
            const filteredData = stockData.filter(item =&gt; 
                !searchValue || 
                item.partNumber.toLowerCase().includes(searchValue) ||
                item.partName.toLowerCase().includes(searchValue) ||
                item.description.toLowerCase().includes(searchValue) ||
                item.category.toLowerCase().includes(searchValue) ||
                item.supplier.toLowerCase().includes(searchValue)
            );
            
            if (filteredData.length === 0) {
                stockTableBody.innerHTML = '&lt;tr&gt;&lt;td colspan=&quot;11&quot; style=&quot;text-align: center;&quot;&gt;No matching records found.&lt;/td&gt;&lt;/tr&gt;';
                return;
            }
            
            filteredData.forEach((item, index) =&gt; {
                const totalValue = item.quantity * item.unitPrice;
                let stockStatus = '';
                let statusClass = '';
                
                if (item.quantity === 0) {
                    stockStatus = 'Out of Stock';
                    statusClass = 'stock-out';
                } else if (item.quantity &lt;= item.minStock) {
                    stockStatus = 'Low Stock';
                    statusClass = 'stock-low';
                } else {
                    stockStatus = 'In Stock';
                    statusClass = 'stock-ok';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    &lt;td&gt;${item.partNumber}&lt;/td&gt;
                    &lt;td&gt;${item.partName}&lt;/td&gt;
                    &lt;td&gt;${item.description}&lt;/td&gt;
                    &lt;td&gt;${item.category}&lt;/td&gt;
                    &lt;td&gt;${item.quantity}&lt;/td&gt;
                    &lt;td class=&quot;price&quot;&gt;AED ${item.unitPrice.toFixed(2)}&lt;/td&gt;
                    &lt;td class=&quot;price&quot;&gt;AED ${totalValue.toFixed(2)}&lt;/td&gt;
                    &lt;td&gt;${item.supplier}&lt;/td&gt;
                    &lt;td&gt;&lt;span class=&quot;stock-alert ${statusClass}&quot;&gt;${stockStatus}&lt;/span&gt;&lt;/td&gt;
                    &lt;td&gt;${item.lastUpdated}&lt;/td&gt;
                    &lt;td class=&quot;action-buttons&quot;&gt;
                        &lt;button class=&quot;action-btn btn-delete&quot; onclick=&quot;deleteStockItem(${index})&quot;&gt;
                            &lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt; Delete
                        &lt;/button&gt;
                    &lt;/td&gt;
                `;
                stockTableBody.appendChild(row);
            });
            
            updateStockSummary(filteredData);
        }
        
        // Render VAT table
        function renderVatTable() {
            vatTableBody.innerHTML = '';
            
            if (vatData.length === 0) {
                vatTableBody.innerHTML = '&lt;tr&gt;&lt;td colspan=&quot;16&quot; style=&quot;text-align: center;&quot;&gt;No VAT data available.&lt;/td&gt;&lt;/tr&gt;';
                return;
            }
            
            const searchValue = vatSearchInput.value.toLowerCase();
            const filteredData = vatData.filter(item =&gt; 
                !searchValue || 
                item.invoiceNumber.toLowerCase().includes(searchValue) ||
                item.partNumber.toLowerCase().includes(searchValue) ||
                item.description.toLowerCase().includes(searchValue) ||
                item.supplier.toLowerCase().includes(searchValue) ||
                item.vehicle.toLowerCase().includes(searchValue) ||
                item.customer.toLowerCase().includes(searchValue) ||
                item.trnNumber.toLowerCase().includes(searchValue)
            );
            
            if (filteredData.length === 0) {
                vatTableBody.innerHTML = '&lt;tr&gt;&lt;td colspan=&quot;16&quot; style=&quot;text-align: center;&quot;&gt;No matching records found.&lt;/td&gt;&lt;/tr&gt;';
                return;
            }
            
            filteredData.forEach((item, index) =&gt; {
                const row = document.createElement('tr');
                row.innerHTML = `
                    &lt;td&gt;${item.date}&lt;/td&gt;
                    &lt;td&gt;${item.invoiceNumber}&lt;/td&gt;
                    &lt;td&gt;${item.partNumber}&lt;/td&gt;
                    &lt;td&gt;${item.description}&lt;/td&gt;
                    &lt;td&gt;${item.quantity}&lt;/td&gt;
                    &lt;td class=&quot;price&quot;&gt;AED ${item.unitPrice.toFixed(2)}&lt;/td&gt;
                    &lt;td&gt;5%&lt;/td&gt;
                    &lt;td class=&quot;price&quot;&gt;AED ${item.vatAmount.toFixed(2)}&lt;/td&gt;
                    &lt;td class=&quot;price&quot;&gt;AED ${item.amountWithoutVat.toFixed(2)}&lt;/td&gt;
                    &lt;td class=&quot;price&quot;&gt;AED ${item.amountWithVat.toFixed(2)}&lt;/td&gt;
                    &lt;td&gt;${item.supplier}&lt;/td&gt;
                    &lt;td&gt;${item.vehicle}&lt;/td&gt;
                    &lt;td&gt;${item.plateNumber}&lt;/td&gt;
                    &lt;td&gt;${item.customer}&lt;/td&gt;
                    &lt;td&gt;${item.trnNumber}&lt;/td&gt;
                    &lt;td class=&quot;action-buttons&quot;&gt;
                        &lt;button class=&quot;action-btn btn-delete&quot; onclick=&quot;deleteVatRecord(${index})&quot;&gt;
                            &lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt; Delete
                        &lt;/button&gt;
                    &lt;/td&gt;
                `;
                vatTableBody.appendChild(row);
            });
            
            updateVatSummary(filteredData);
        }
        
        // Update filter dropdowns with unique values
        function updateFilters() {
            // Get unique values for each filter
            const customers = [...new Set(partsData.map(part =&gt; part.customerName))];
            const vehicles = [...new Set(partsData.map(part =&gt; part.vehicle))];
            const suppliers = [...new Set(partsData.map(part =&gt; part.supplierName))];
            const parts = [...new Set(partsData.map(part =&gt; part.partsName))];
            
            // Update customer filter
            customerFilter.innerHTML = '&lt;option value=&quot;&quot;&gt;All Customers&lt;/option&gt;';
            customers.forEach(customer =&gt; {
                customerFilter.innerHTML += `&lt;option value=&quot;${customer}&quot;&gt;${customer}&lt;/option&gt;`;
            });
            
            // Update vehicle filter
            vehicleFilter.innerHTML = '&lt;option value=&quot;&quot;&gt;All Vehicles&lt;/option&gt;';
            vehicles.forEach(vehicle =&gt; {
                vehicleFilter.innerHTML += `&lt;option value=&quot;${vehicle}&quot;&gt;${vehicle}&lt;/option&gt;`;
            });
            
            // Update supplier filter
            supplierFilter.innerHTML = '&lt;option value=&quot;&quot;&gt;All Suppliers&lt;/option&gt;';
            suppliers.forEach(supplier =&gt; {
                supplierFilter.innerHTML += `&lt;option value=&quot;${supplier}&quot;&gt;${supplier}&lt;/option&gt;`;
            });
            
            // Update parts filter
            partsFilter.innerHTML = '&lt;option value=&quot;&quot;&gt;All Parts&lt;/option&gt;';
            parts.forEach(part =&gt; {
                partsFilter.innerHTML += `&lt;option value=&quot;${part}&quot;&gt;${part}&lt;/option&gt;`;
            });
        }
        
        // Apply filters to table
        function applyFilters() {
            renderPartsTable();
        }
        
        // Apply search to table
        function applySearch() {
            renderPartsTable();
        }
        
        // Apply stock search
        function applyStockSearch() {
            renderStockTable();
        }
        
        // Apply VAT search
        function applyVatSearch() {
            renderVatTable();
        }
        
        // Update parts summary cards with filtered data
        function updatePartsSummary(filteredData = null) {
            const dataToUse = filteredData || partsData;
            const totalData = partsData.length;
            
            document.getElementById('totalParts').textContent = dataToUse.length;
            document.getElementById('totalPartsInfo').textContent = `of ${totalData} total`;
            
            if (dataToUse.length === 0) {
                document.getElementById('avgOriginal').textContent = 'AED 0.00';
                document.getElementById('avgAfterMarket').textContent = 'AED 0.00';
                document.getElementById('avgUsed').textContent = 'AED 0.00';
                
                document.getElementById('avgOriginalInfo').textContent = 'of AED 0.00';
                document.getElementById('avgAfterMarketInfo').textContent = 'of AED 0.00';
                document.getElementById('avgUsedInfo').textContent = 'of AED 0.00';
                return;
            }
            
            // Calculate overall averages for comparison
            const overallAvgOriginal = partsData.reduce((sum, part) =&gt; sum + part.originalPrice, 0) / totalData;
            const overallAvgAfterMarket = partsData.reduce((sum, part) =&gt; sum + part.afterMarketPrice, 0) / totalData;
            const overallAvgUsed = partsData.reduce((sum, part) =&gt; sum + part.usedPrice, 0) / totalData;
            
            // Calculate filtered averages
            const avgOriginal = dataToUse.reduce((sum, part) =&gt; sum + part.originalPrice, 0) / dataToUse.length;
            const avgAfterMarket = dataToUse.reduce((sum, part) =&gt; sum + part.afterMarketPrice, 0) / dataToUse.length;
            const avgUsed = dataToUse.reduce((sum, part) =&gt; sum + part.usedPrice, 0) / dataToUse.length;
            
            document.getElementById('avgOriginal').textContent = `AED ${avgOriginal.toFixed(2)}`;
            document.getElementById('avgAfterMarket').textContent = `AED ${avgAfterMarket.toFixed(2)}`;
            document.getElementById('avgUsed').textContent = `AED ${avgUsed.toFixed(2)}`;
            
            document.getElementById('avgOriginalInfo').textContent = `of AED ${overallAvgOriginal.toFixed(2)}`;
            document.getElementById('avgAfterMarketInfo').textContent = `of AED ${overallAvgAfterMarket.toFixed(2)}`;
            document.getElementById('avgUsedInfo').textContent = `of AED ${overallAvgUsed.toFixed(2)}`;
        }
        
        // Update stock summary
        function updateStockSummary(filteredData = null) {
            const dataToUse = filteredData || stockData;
            
            const totalItems = dataToUse.length;
            const totalStockValue = dataToUse.reduce((sum, item) =&gt; sum + (item.quantity * item.unitPrice), 0);
            const lowStockItems = dataToUse.filter(item =&gt; item.quantity &gt; 0 &amp;&amp; item.quantity &lt;= item.minStock).length;
            const outOfStock = dataToUse.filter(item =&gt; item.quantity === 0).length;
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalStockValue').textContent = `AED ${totalStockValue.toFixed(2)}`;
            document.getElementById('lowStockItems').textContent = lowStockItems;
            document.getElementById('outOfStock').textContent = outOfStock;
        }
        
        // Update VAT summary
        function updateVatSummary(filteredData = null) {
            const dataToUse = filteredData || vatData;
            
            const totalVatAmount = dataToUse.reduce((sum, item) =&gt; sum + item.vatAmount, 0);
            const totalWithoutVat = dataToUse.reduce((sum, item) =&gt; sum + item.amountWithoutVat, 0);
            const totalWithVat = dataToUse.reduce((sum, item) =&gt; sum + item.amountWithVat, 0);
            const totalInvoices = dataToUse.length;
            
            document.getElementById('totalVatAmount').textContent = `AED ${totalVatAmount.toFixed(2)}`;
            document.getElementById('totalWithoutVat').textContent = `AED ${totalWithoutVat.toFixed(2)}`;
            document.getElementById('totalWithVat').textContent = `AED ${totalWithVat.toFixed(2)}`;
            document.getElementById('totalInvoices').textContent = totalInvoices;
        }
        
        // Export to Excel
        function exportToExcel() {
            let dataToExport = [];
            let fileName = '';
            
            // Determine which page is active
            if (document.getElementById('partsPage').classList.contains('active')) {
                dataToExport = partsData;
                fileName = 'parts_data.xlsx';
            } else if (document.getElementById('stockPage').classList.contains('active')) {
                dataToExport = stockData;
                fileName = 'stock_data.xlsx';
            } else if (document.getElementById('vatPage').classList.contains('active')) {
                dataToExport = vatData;
                fileName = 'vat_data.xlsx';
            }
            
            if (dataToExport.length === 0) {
                alert('No data to export!');
                return;
            }
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            
            // Export to file
            XLSX.writeFile(wb, fileName);
        }
        
        // Open password modal
        function openPasswordModal() {
            document.getElementById('passwordInput').value = '';
            passwordModal.style.display = 'flex';
        }
        
        // Close password modal
        function closePasswordModal() {
            passwordModal.style.display = 'none';
        }
        
        // Clear all data with password protection
        function clearAllData() {
            const password = document.getElementById('passwordInput').value;
            
            if (password !== PASSWORD) {
                alert('Incorrect password!');
                return;
            }
            
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
                partsData = [];
                stockData = [];
                vatData = [];
                stockHistory = [];
                localStorage.removeItem('partsData');
                localStorage.removeItem('stockData');
                localStorage.removeItem('vatData');
                localStorage.removeItem('stockHistory');
                renderPartsTable();
                renderStockTable();
                renderVatTable();
                updateFilters();
                updatePartsSummary();
                updateStockSummary();
                updateVatSummary();
                updateTrackPartDropdown();
                closePasswordModal();
            }
        }
        
        // Add sample parts data for demonstration
        function addSamplePartsData() {
            const sampleData = [
                {
                    date: '2023-10-15',
                    customerName: 'Ali',
                    vehicle: 'Toyota Corolla',
                    supplierName: 'Auto Parts Ltd.',
                    partsName: 'Brake Pads',
                    partsCategory: 'Braking System',
                    originalPrice: 440,
                    afterMarketPrice: 290,
                    usedPrice: 145
                },
                {
                    date: '2023-10-16',
                    customerName: 'Ahmed',
                    vehicle: 'Honda Civic',
                    supplierName: 'Car Solutions',
                    partsName: 'Oil Filter',
                    partsCategory: 'Engine',
                    originalPrice: 90,
                    afterMarketPrice: 55,
                    usedPrice: 30
                },
                {
                    date: '2023-10-17',
                    customerName: 'Fatima',
                    vehicle: 'Suzuki Mehran',
                    supplierName: 'Mehran Autos',
                    partsName: 'Spark Plug',
                    partsCategory: 'Ignition',
                    originalPrice: 165,
                    afterMarketPrice: 110,
                    usedPrice: 55
                }
            ];
            
            partsData = [...partsData, ...sampleData];
            localStorage.setItem('partsData', JSON.stringify(partsData));
            renderPartsTable();
            updateFilters();
            updatePartsSummary();
        }
        
        // Add sample stock data
        function addSampleStockData() {
            const sampleData = [
                {
                    partNumber: 'BP-T-001',
                    partName: 'Brake Pads',
                    description: 'Front brake pads for Toyota',
                    category: 'Braking System',
                    quantity: 15,
                    unitPrice: 440,
                    supplier: 'Auto Parts Ltd.',
                    minStock: 5,
                    maxStock: 50,
                    lastUpdated: '2023-10-15'
                },
                {
                    partNumber: 'OF-H-002',
                    partName: 'Oil Filter',
                    description: 'Oil filter for Honda',
                    category: 'Engine',
                    quantity: 25,
                    unitPrice: 90,
                    supplier: 'Car Solutions',
                    minStock: 5,
                    maxStock: 50,
                    lastUpdated: '2023-10-16'
                },
                {
                    partNumber: 'SP-S-003',
                    partName: 'Spark Plug',
                    description: 'Spark plug for Suzuki',
                    category: 'Ignition',
                    quantity: 3,
                    unitPrice: 165,
                    supplier: 'Mehran Autos',
                    minStock: 5,
                    maxStock: 50,
                    lastUpdated: '2023-10-17'
                },
                {
                    partNumber: 'ALT-T-004',
                    partName: 'Alternator',
                    description: 'Alternator for Toyota Hilux',
                    category: 'Electrical',
                    quantity: 0,
                    unitPrice: 1175,
                    supplier: 'Tokyo Motors',
                    minStock: 5,
                    maxStock: 50,
                    lastUpdated: '2023-10-18'
                }
            ];
            
            stockData = [...stockData, ...sampleData];
            localStorage.setItem('stockData', JSON.stringify(stockData));
            
            // Add sample history
            sampleData.forEach(item =&gt; {
                addStockHistory(item.partNumber, 'add', item.quantity, `Initial stock added: ${item.quantity}`);
            });
            
            localStorage.setItem('stockHistory', JSON.stringify(stockHistory));
            
            renderStockTable();
            updateStockSummary();
            updateTrackPartDropdown();
        }
        
        // Add sample VAT data
        function addSampleVatData() {
            const sampleData = [
                {
                    date: '2023-10-15',
                    invoiceNumber: 'INV-001',
                    partNumber: 'BP-T-001',
                    description: 'Brake Pads for Toyota',
                    quantity: 2,
                    unitPrice: 440,
                    vatAmount: 44,
                    amountWithoutVat: 880,
                    amountWithVat: 924,
                    supplier: 'Auto Parts Ltd.',
                    vehicle: 'Toyota Corolla',
                    plateNumber: 'ABC-123',
                    customer: 'Ali',
                    trnNumber: 'TRN123456'
                },
                {
                    date: '2023-10-16',
                    invoiceNumber: 'INV-002',
                    partNumber: 'OF-H-002',
                    description: 'Oil Filter for Honda',
                    quantity: 1,
                    unitPrice: 90,
                    vatAmount: 4.5,
                    amountWithoutVat: 90,
                    amountWithVat: 94.5,
                    supplier: 'Car Solutions',
                    vehicle: 'Honda Civic',
                    plateNumber: 'XYZ-789',
                    customer: 'Ahmed',
                    trnNumber: 'TRN789012'
                },
                {
                    date: '2023-10-17',
                    invoiceNumber: 'INV-003',
                    partNumber: 'SP-S-003',
                    description: 'Spark Plug for Suzuki',
                    quantity: 4,
                    unitPrice: 165,
                    vatAmount: 33,
                    amountWithoutVat: 660,
                    amountWithVat: 693,
                    supplier: 'Mehran Autos',
                    vehicle: 'Suzuki Mehran',
                    plateNumber: 'DEF-456',
                    customer: 'Fatima',
                    trnNumber: 'TRN345678'
                }
            ];
            
            vatData = [...vatData, ...sampleData];
            localStorage.setItem('vatData', JSON.stringify(vatData));
            renderVatTable();
            updateVatSummary();
        }
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;" style="width:100%;height:80vh;border:1px solid #e5e7eb;border-radius:12px;background:#fff"></iframe></section></div>
<footer>All rights reserved BY Qasim Aziz</footer>
<script>
/* ---------- Local Storage Helper ---------- */
const LS = {
  get: (k, fallback) => {
    try { 
      const v = localStorage.getItem(k); 
      console.log(`📖 LS.get: ${k} - ${v ? 'Found' : 'Not found'}`);
      return v ? JSON.parse(v) : fallback; 
    } 
    catch (e) { 
      console.error('❌ LS.get error', k, e); 
      // Try sessionStorage fallback
      try {
        const sv = sessionStorage.getItem(k);
        return sv ? JSON.parse(sv) : fallback;
      } catch (e2) {
        return fallback;
      }
    }
  },
  set: (k, v) => {
    try { 
      localStorage.setItem(k, JSON.stringify(v));
      console.log(`💾 LS.set success: ${k}`);
    }
    catch (e) {
      console.error('❌ LS.set error', k, e);
      // Try sessionStorage fallback
      try {
        sessionStorage.setItem(k, JSON.stringify(v));
        console.log(`💾 LS.set fallback success: ${k}`);
      } catch (e2) {
        console.error('❌ LS.set complete failure', k, e2);
        alert('Storage error: Unable to save data. Please check browser settings or free up storage.');
      }
    }
  },
  remove: (k) => {
    try {
      localStorage.removeItem(k);
      sessionStorage.removeItem(k);
      console.log(`🗑️ LS.remove: ${k}`);
    } catch (e) {
      console.error('❌ LS.remove error', k, e);
    }
  }
};

// Ensure nativeStorage exists for web compatibility  
if (!window.nativeStorage) {
  window.nativeStorage = {
    save: async (data) => {
      console.log('💾 nativeStorage.save called with data size:', JSON.stringify(data).length);
      try {
        LS.set('native_app_data', data);
        return { success: true };
      } catch (error) {
        console.error('❌ nativeStorage.save failed:', error);
        return { success: false, error: error.message };
      }
    },
    load: async () => {
      console.log('📖 nativeStorage.load called');
      try {
        const data = LS.get('native_app_data', null);
        console.log('📖 nativeStorage.load result:', data ? 'Data found' : 'No data');
        return { success: true, data };
      } catch (error) {
        console.error('❌ nativeStorage.load failed:', error);
        return { success: false, error: error.message };
      }
    }
  };
  console.log('🔧 nativeStorage initialized for web compatibility');
}



/* ---------- App State ---------- */
let state = {
  transactions: LS.get('transactions', []),
  categories: LS.get('categories', ['Sales', 'Purchase', 'Salary', 'Rent', 'Fuel', 'Maintenance', 'Other']),
  accounts: LS.get('accounts', ['Cash', 'Bank', 'Credit Card']),
  users: LS.get('users', [{ username: 'admin', password: 'admin', role: 'admin' }]),
  employees: LS.get('employees', []),
  payroll: LS.get('payroll', []),
  advances: LS.get('advances', []),
  attendance: LS.get('attendance', []),
  currentUser: null,
  settings: LS.get('settings', { companyName: 'Esthetics Auto', companyAddress: 'Dubai, UAE', currency: 'AED' })
};

// ---- Native file persistence (Electron) ----
async function saveNativeSnapshot(){
  try{
    if (window.nativeStorage && typeof window.nativeStorage.save === 'function'){
      const snapshot = {
        transactions: state.transactions,
        categories: state.categories,
        accounts: state.accounts,
        users: state.users,
        employees: state.employees,
        payroll: state.payroll,
        advances: state.advances,
        attendance: state.attendance,
        settings: state.settings,
        savedAt: new Date().toISOString()
      };
      const res = await window.nativeStorage.save(snapshot);
      if (!res?.ok){ console.warn('Native save failed', res?.error); }
    }
  }catch(e){ console.warn('Native save error', e); }
}

async function loadNativeSnapshot(){
  try{
    if (window.nativeStorage && typeof window.nativeStorage.load === 'function'){
      const res = await window.nativeStorage.load();
      if (res?.ok && res.data){
        const d = res.data;
        state.transactions = d.transactions || state.transactions;
        state.categories = d.categories || state.categories;
        state.accounts = d.accounts || state.accounts;
        state.users = d.users || state.users;
        state.employees = d.employees || state.employees;
        state.payroll = d.payroll || state.payroll;
        state.advances = d.advances || state.advances;
        state.attendance = d.attendance || state.attendance;
        state.settings = d.settings || state.settings;
        // Also mirror into localStorage
        LS.set('transactions', state.transactions);
        LS.set('categories', state.categories);
        LS.set('accounts', state.accounts);
        LS.set('users', state.users);
        LS.set('employees', state.employees);
        LS.set('payroll', state.payroll);
        LS.set('advances', state.advances);
        LS.set('attendance', state.attendance);
        LS.set('settings', state.settings);
        // Refresh screens if visible
        try{ loadTransactions(); loadDashboard(); }catch(_){}
      }
    }
  }catch(e){ console.warn('Native load error', e); }
}

// Initialize current user from session if available
const sessionUser = sessionStorage.getItem('currentUser');
if (sessionUser) {
  state.currentUser = JSON.parse(sessionUser);
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('menu').classList.remove('hidden');
  document.getElementById('currentUser').textContent = state.currentUser.username;
  showSection('transactions');
}

/* ---------- Login Functions ---------- */
function login() {
  const username = document.getElementById('loginUser').value;
  const password = document.getElementById('loginPass').value;
  
  console.log('Login attempt:', { username, password, users: state.users });
  
  const user = state.users.find(u => u.username === username && u.password === password);
  if (user) {
    state.currentUser = user;
    sessionStorage.setItem('currentUser', JSON.stringify(user));
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('menu').classList.remove('hidden');
    document.getElementById('currentUser').textContent = username;
    showSection('transactions');
    loadAllData();
    console.log('Login successful');
  } else {
    console.log('Login failed - user not found');
    alert('Invalid username or password\n\nDefault credentials:\nUsername: admin\nPassword: admin');
  }
}

function handleLoginKeyPress(event) {
  if (event.key === 'Enter') {
    login();
  }
}

function logout() {
  state.currentUser = null;
  sessionStorage.removeItem('currentUser');
  document.getElementById('app').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
}

/* ---------- Navigation ---------- */
function showSection(section) {
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  
  document.getElementById(`${section}Section`).classList.remove('hidden');
  const btn = document.getElementById(`btn${section.charAt(0).toUpperCase() + section.slice(1)}`);
  if (btn) { btn.classList.add('active'); }
  
  if (section === 'dashboard') {
    loadDashboard();
  } else if (section === 'transactions') {
    loadTransactions(); try{loadDashboardTransactions()}catch(e){}
  } else if (section === 'employees') {
    loadEmployees();
  } else if (section === 'settings') {
    if (!state.currentUser || state.currentUser.role !== 'admin') {
      alert('Only admin can access settings');
      showSection('transactions');
      return;
    }
    loadSettings();
  }
}

/* ---------- Dashboard ---------- */
function loadDashboard() {
  loadAccountSummary();
  loadDashboardSummary();
  loadDashboardTransactions();
  loadTodaySummary();
  populateFilterDropdowns();
}

function loadTodaySummary() {
  const today = new Date().toISOString().split('T')[0];
  const todayTransactions = state.transactions.filter(t => t.date === today);
  
  let todayIncome = 0;
  let todayExpense = 0;
  
  todayTransactions.forEach(t => {
    if (t.type === 'income') todayIncome += parseFloat(t.amount);
    else if (t.type === 'expense') todayExpense += parseFloat(t.amount);
  });
  
  const todayNet = todayIncome - todayExpense;
  
  const todaySummaryEl = document.getElementById('todaySummary');
  todaySummaryEl.innerHTML = `
    <div class="card" style="min-width:200px;">
      <div style="font-size:12px;color:#6b7280;">Today's Income</div>
      <div class="today-positive-amount" style="font-size:20px;font-weight:800;">${formatCurrency(todayIncome)}</div>
    </div>
    <div class="card" style="min-width:200px;">
      <div style="font-size:12px;color:#6b7280;">Today's Expense</div>
      <div class="today-negative-amount" style="font-size:20px;font-weight:800;">${formatCurrency(todayExpense)}</div>
    </div>
    <div class="card" style="min-width:200px;">
      <div style="font-size:12px;color:#6b7280;">Today's Net</div>
      <div class="${todayNet >= 0 ? 'today-positive-amount' : 'today-negative-amount'}" style="font-size:20px;font-weight:800;">${formatCurrency(todayNet)}</div>
    </div>
  `;
}

function loadAccountSummary() {
  // Get filtered transactions based on current filters
  const filteredTransactions = filterTransactions();
  
  const accountSummary = {};
  
  filteredTransactions.forEach(t => {
    if (!accountSummary[t.account]) {
      accountSummary[t.account] = { income: 0, expense: 0 };
    }
    
    if (t.type === 'income') {
      accountSummary[t.account].income += parseFloat(t.amount);
    } else if (t.type === 'expense') {
      accountSummary[t.account].expense += parseFloat(t.amount);
    }
  });
  
  const accountSummaryEl = document.getElementById('accountSummary');
  accountSummaryEl.innerHTML = '';
  
  for (const account in accountSummary) {
    const net = accountSummary[account].income - accountSummary[account].expense;
    accountSummaryEl.innerHTML += `
      <div class="card" style="min-width:200px;">
        <div style="font-size:12px;color:#6b7280;">${account}</div>
        <div style="font-size:14px;margin-top:4px;">Income: <span class="positive-amount">${formatCurrency(accountSummary[account].income)}</span></div>
        <div style="font-size:14px;">Expense: <span class="negative-amount">${formatCurrency(accountSummary[account].expense)}</span></div>
        <div style="font-size:16px;margin-top:4px;font-weight:700;">Net: <span class="${net >= 0 ? 'positive-amount' : 'negative-amount'}">${formatCurrency(net)}</span></div>
      </div>
    `;
  }
}

function loadDashboardSummary() {
  // Get filtered transactions based on current filters
  const filteredTransactions = filterTransactions();
  
  let totalIncome = 0;
  let totalExpense = 0;
  
  filteredTransactions.forEach(t => {
    if (t.type === 'income') totalIncome += parseFloat(t.amount);
    else if (t.type === 'expense') totalExpense += parseFloat(t.amount);
  });
  
  const net = totalIncome - totalExpense;
  
  const dashboardSummaryEl = document.getElementById('dashboardSummary');
  dashboardSummaryEl.innerHTML = `
    <div class="card" style="min-width:200px;">
      <div style="font-size:12px;color:#6b7280;">Total Income</div>
      <div class="positive-amount" style="font-size:20px;font-weight:800;">${formatCurrency(totalIncome)}</div>
    </div>
    <div class="card" style="min-width:200px;">
      <div style="font-size:12px;color:#6b7280;">Total Expense</div>
      <div class="negative-amount" style="font-size:20px;font-weight:800;">${formatCurrency(totalExpense)}</div>
    </div>
    <div class="card" style="min-width:200px;">
      <div style="font-size:12px;color:#6b7280;">Net Balance</div>
      <div class="${net >= 0 ? 'positive-amount' : 'negative-amount'}" style="font-size:20px;font-weight:800;">${formatCurrency(net)}</div>
    </div>
  `;
}

function loadDashboardTransactions() {
  const filteredTransactions = filterTransactions();
  const limitedTransactions = filteredTransactions.slice(0, 50); // Limit to 50 transactions
  
  const tbody = document.querySelector('#dashboardTransactionsTable tbody');
  tbody.innerHTML = '';
  if (!limitedTransactions.length) {
    const row = document.createElement('tr');
    row.innerHTML = `<td colspan="8" style="text-align:center;color:#6b7280;">No transactions to show</td>`;
    tbody.appendChild(row);
    return;
  }
  
  limitedTransactions.forEach(t => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatDisplayDate(t.date)}</td>
      <td>${t.category}</td>
      <td>${t.transactionId || '-'}</td>
      <td>${t.vendor || '-'}</td>
      <td>${t.account}</td>
      <td class="${t.type === 'income' ? 'positive-amount' : 'negative-amount'}">${formatDisplayAmount(t.amount)}</td>
      <td>${t.description || '-'}</td>
      <td>${t.type}</td>
    `;
    tbody.appendChild(row);
  });
}

function populateFilterDropdowns() {
  const categorySelect = document.getElementById('filterCategory');
  const accountSelect = document.getElementById('filterAccount');
  
  categorySelect.innerHTML = '<option value="">All Categories</option>';
  accountSelect.innerHTML = '<option value="">All Accounts</option>';
  
  state.categories.forEach(c => {
    categorySelect.innerHTML += `<option value="${c}">${c}</option>`;
  });
  
  state.accounts.forEach(a => {
    accountSelect.innerHTML += `<option value="${a}">${a}</option>`;
  });
}

function applyFilters(updateDashboard = false) {
  if (updateDashboard) {
    // Update all dashboard sections with filtered data
    loadAccountSummary();
    loadDashboardSummary();
    loadDashboardTransactions();
  } else {
    loadTransactions(); try{loadDashboardTransactions()}catch(e){}
  }
}

function clearFilters(skipRefresh = false) {
  document.getElementById('filterStart').value = '';
  document.getElementById('filterEnd').value = '';
  document.getElementById('filterCategory').value = '';
  document.getElementById('filterAccount').value = '';
  document.getElementById('filterType').value = '';
  if (!skipRefresh) {
    applyFilters(true);
  }
}

function filterTransactions() {
  const startDate = document.getElementById('filterStart').value;
  const endDate = document.getElementById('filterEnd').value;
  const category = document.getElementById('filterCategory').value;
  const account = document.getElementById('filterAccount').value;
  const type = document.getElementById('filterType').value;
  
  const filtered = state.transactions.filter(t => {
    if (startDate && t.date < startDate) return false;
    if (endDate && t.date > endDate) return false;
    if (category && t.category !== category) return false;
    if (account && t.account !== account) return false;
    if (type && t.type !== type) return false;
    return true;
  });
  
  // Sort filtered transactions by newest first
  return filtered.sort((a,b)=> {
    const aCreated = new Date(a.createdAt || a.date || '1970-01-01').getTime();
    const bCreated = new Date(b.createdAt || b.date || '1970-01-01').getTime();
    
    if (aCreated !== bCreated) {
      return bCreated - aCreated; // Newest first
    }
    
    const aDate = new Date(a.date || '1970-01-01').getTime();
    const bDate = new Date(b.date || '1970-01-01').getTime();
    return bDate - aDate;
  });
}

/* ---------- Transactions ---------- */
function loadTransactions(){
  const tbody = document.querySelector('#transactionsTable tbody');
  tbody.innerHTML='';
  const sorted = (state.transactions||[]).slice().sort((a,b)=> {
    // Sort by createdAt first (newest first), then by date (newest first)
    const aCreated = new Date(a.createdAt || a.date || '1970-01-01').getTime();
    const bCreated = new Date(b.createdAt || b.date || '1970-01-01').getTime();
    
    // If createdAt times are different, sort by them
    if (aCreated !== bCreated) {
      return bCreated - aCreated; // Newest first
    }
    
    // If same createdAt, sort by date (newest first)
    const aDate = new Date(a.date || '1970-01-01').getTime();
    const bDate = new Date(b.date || '1970-01-01').getTime();
    return bDate - aDate;
  });
  if (!sorted.length) {
    const row = document.createElement('tr');
    row.innerHTML = `<td colspan="9" style="text-align:center;color:#6b7280;">No transactions yet</td>`;
    tbody.appendChild(row);
    return;
  }
  sorted.forEach((t, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatDisplayDate(t.date)}</td>
      <td>${t.category}</td>
      <td>${t.transactionId || '-'}</td>
      <td>${t.vendor || '-'}</td>
      <td>${t.account}</td>
      <td class="${t.type === 'income' ? 'positive-amount' : 'negative-amount'}">${formatDisplayAmount(t.amount)}</td>
      <td>${t.description || '-'}</td>
      <td>${t.type}</td>
      <td>
        <button class="action-btn" onclick="editTransaction(${i})" ${canEditTransaction(t) && editingTransaction === null ? '' : 'disabled'}><i class="fa-solid fa-pen"></i></button>
        <button class="action-btn" onclick="deleteTransaction(${i})" ${canEditTransaction(t) && editingTransaction === null ? '' : 'disabled'}><i class="fa-solid fa-trash"></i></button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function canEditTransaction(transaction) {
  if (!state.currentUser) return false;
  if (state.currentUser.role === 'admin') return true;
  if (transaction.createdBy !== state.currentUser.username) return false;
  
  // Users can only edit their own transactions within 10 minutes of creation
  const createdTime = new Date(transaction.createdAt).getTime();
  const currentTime = new Date().getTime();
  const tenMinutes = 10 * 60 * 1000;
  
  return (currentTime - createdTime) < tenMinutes;
}

document.getElementById('transactionForm').addEventListener('submit', function(e) {
  e.preventDefault();
  try {
  
  const transaction = {
    date: document.getElementById('date').value,
    category: document.getElementById('category').value,
    transactionId: document.getElementById('transactionId').value,
    vendor: document.getElementById('vendor').value,
    account: document.getElementById('account').value,
    amount: (function(){ const v = parseFloat(document.getElementById('amount').value); return isNaN(v)?0:v; })(),
    description: document.getElementById('description').value,
    type: document.getElementById('transactionType').value,
    createdAt: editingTransaction && editingTransaction.createdAt ? editingTransaction.createdAt : new Date().toISOString(),
    createdBy: editingTransaction ? editingTransaction.createdBy : ((state.currentUser && state.currentUser.username) ? state.currentUser.username : 'anonymous'),
    editedAt: editingTransaction ? new Date().toISOString() : undefined,
    editedBy: editingTransaction ? ((state.currentUser && state.currentUser.username) ? state.currentUser.username : 'anonymous') : undefined
  };
  
  if (!transaction.date) { showTransactionToast('Please select a date'); return; }
  if (!transaction.category) { showTransactionToast('Please select a category'); return; }
  if (!transaction.account) { showTransactionToast('Please select an account'); return; }
  if (transaction.amount <= 0) { showTransactionToast('Please enter a valid amount'); return; }
  
  // Save to localStorage (immediate)
  state.transactions.push(transaction);
  LS.set('transactions', state.transactions);
  saveNativeSnapshot();
  
  // Local storage only - no cloud sync
  
  // Removed the alert message
  resetForm();
  editingTransaction = null; // Clear editing state
  // Refresh UI fully after save
  try { loadTransactions(); loadDashboard(); } catch(e) { console.warn('Post-save UI refresh failed', e); }
  
  showTransactionToast('Transaction saved');
  } catch(err){
  console.error('Submit error', err);
  showTransactionToast('Failed to save: ' + (err?.message || err));
  }
});

function resetForm() {
  // Only clear amount, description, and transactionId - keep date, category, account
  document.getElementById('amount').value = '';
  document.getElementById('description').value = '';
  document.getElementById('transactionId').value = '';
  document.getElementById('vendor').value = '';
  
  // Keep date as today if empty, otherwise keep current value
  if (!document.getElementById('date').value) {
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
  }
  
  editingTransaction = null;
}

// Toast notification for transaction save (global scope)
function showTransactionToast(msg) {
  console.log('🔔 Toast function called with message:', msg);
  
  let toast = document.createElement('div');
  let icon = document.createElement('span');
  icon.style.marginRight = '12px';
  icon.style.fontSize = '22px';
  icon.style.verticalAlign = 'middle';
  if (msg.toLowerCase().includes('saved')) {
    icon.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
  } else {
    icon.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i>';
  }
  toast.appendChild(icon);
  let text = document.createElement('span');
  text.textContent = msg;
  toast.appendChild(text);
  toast.style.position = 'fixed';
  toast.style.top = '20px';
  toast.style.left = '50%';
  toast.style.transform = 'translateX(-50%)';
  toast.style.background = msg.toLowerCase().includes('saved') ? '#16a34a' : '#f59e0b';
  toast.style.color = '#fff';
  toast.style.padding = '16px 32px';
  toast.style.borderRadius = '12px';
  toast.style.fontWeight = 'bold';
  toast.style.fontSize = '16px';
  toast.style.zIndex = '99999';
  toast.style.boxShadow = '0 4px 16px rgba(0,0,0,0.3)';
  toast.style.letterSpacing = '1px';
  toast.style.textAlign = 'center';
  toast.style.maxWidth = '90vw';
  toast.style.pointerEvents = 'none';
  toast.style.minWidth = '200px';
  document.body.appendChild(toast);
  
  console.log('✅ Toast element created and added to body');
  
  setTimeout(() => {
    toast.remove();
    console.log('🗑️ Toast removed after timeout');
  }, 3000);
}

let editingTransaction = null;

function editTransaction(index) {
  const t = state.transactions[index];
  
  // Store original transaction data for editing
  editingTransaction = {...t};
  
  document.getElementById('date').value = t.date;
  document.getElementById('category').value = t.category;
  document.getElementById('transactionId').value = t.transactionId || '';
  document.getElementById('vendor').value = t.vendor || '';
  document.getElementById('account').value = t.account;
  document.getElementById('amount').value = t.amount;
  document.getElementById('description').value = t.description || '';
  document.getElementById('transactionType').value = t.type;
  
  // Remove the old transaction
  state.transactions.splice(index, 1);
  LS.set('transactions', state.transactions);
  
  loadTransactions(); try{loadDashboardTransactions()}catch(e){}
}

function deleteTransaction(index) {
  if (confirm('Are you sure you want to delete this transaction?')) {
    state.transactions.splice(index, 1);
    LS.set('transactions', state.transactions);
    loadTransactions(); try{loadDashboardTransactions()}catch(e){}
    loadDashboard();
  }
}

/* ---------- Settings ---------- */
function loadSettings() {
  // Categories
  const categoryChips = document.getElementById('categoryChips');
  categoryChips.innerHTML = '';
  state.categories.forEach(c => {
    categoryChips.innerHTML += `
      <div class="chip">${c} <button onclick="removeCategory('${c}')"><i class="fa-solid fa-xmark"></i></button></div>
    `;
  });
  
  // Accounts
  const accountChips = document.getElementById('accountChips');
  accountChips.innerHTML = '';
  state.accounts.forEach(a => {
    accountChips.innerHTML += `
      <div class="chip">${a} <button onclick="removeAccount('${a}')"><i class="fa-solid fa-xmark"></i></button></div>
    `;
  });
  
  // Users
  const usersTableBody = document.getElementById('usersTableBody');
  usersTableBody.innerHTML = '';
  state.users.forEach((u, i) => {
    if (u.username === 'admin' && state.currentUser.username !== 'admin') return; // Only admin can see other admins
    
    usersTableBody.innerHTML += `
      <tr>
        <td>${u.username}</td>
        <td>${u.role}</td>
        <td>
          ${u.username !== state.currentUser.username ? `
            <button class="action-btn" onclick="deleteUser(${i})"><i class="fa-solid fa-trash"></i></button>
          ` : ''}
        </td>
      </tr>
    `;
  });
}

function addCategory() {
  const newCategory = document.getElementById('newCategory').value.trim();
  if (!newCategory) return;
  
  if (!state.categories.includes(newCategory)) {
    state.categories.push(newCategory);
    LS.set('categories', state.categories);
    
    // Update the category dropdown in the transaction form immediately
    updateCategoryDropdown();
    
    loadSettings();
    document.getElementById('newCategory').value = '';
  } else {
    alert('Category already exists');
  }
}

function updateCategoryDropdown() {
  const categorySelect = document.getElementById('category');
  categorySelect.innerHTML = '';
  
  state.categories.forEach(c => {
    categorySelect.innerHTML += `<option value="${c}">${c}</option>`;
  });
}

function removeCategory(category) {
  if (confirm(`Remove category "${category}"? This won't affect existing transactions.`)) {
    state.categories = state.categories.filter(c => c !== category);
    LS.set('categories', state.categories);
    
    // Update the category dropdown in the transaction form immediately
    updateCategoryDropdown();
    
    loadSettings();
  }
}

function addAccount() {
  const newAccount = document.getElementById('newAccount').value.trim();
  if (!newAccount) return;
  
  if (!state.accounts.includes(newAccount)) {
    state.accounts.push(newAccount);
    LS.set('accounts', state.accounts);
    
    // Update the account dropdown in the transaction form immediately
    updateAccountDropdown();
    
    loadSettings();
    document.getElementById('newAccount').value = '';
  } else {
    alert('Account already exists');
  }
}

function updateAccountDropdown() {
  const accountSelect = document.getElementById('account');
  accountSelect.innerHTML = '';
  
  state.accounts.forEach(a => {
    accountSelect.innerHTML += `<option value="${a}">${a}</option>`;
  });
}

function removeAccount(account) {
  if (confirm(`Remove account "${account}"? This won't affect existing transactions.`)) {
    state.accounts = state.accounts.filter(a => a !== account);
    LS.set('accounts', state.accounts);
    
    // Update the account dropdown in the transaction form immediately
    updateAccountDropdown();
    
    loadSettings();
  }
}

function addUser() {
  const username = document.getElementById('newUsername').value.trim();
  const password = document.getElementById('newPassword').value;
  const role = document.getElementById('newRole').value;
  
  if (!username || !password) {
    alert('Username and password are required');
    return;
  }
  
  if (state.users.some(u => u.username === username)) {
    alert('Username already exists');
    return;
  }
  
  state.users.push({ username, password, role });
  LS.set('users', state.users);
  loadSettings();
  
  document.getElementById('newUsername').value = '';
  document.getElementById('newPassword').value = '';
}

function deleteUser(index) {
  if (confirm('Are you sure you want to delete this user?')) {
    state.users.splice(index, 1);
    LS.set('users', state.users);
    loadSettings();
  }
}

function deleteAllTransactions() {
  if (state.currentUser.role !== 'admin') {
    alert('Only admin can delete all transactions');
    return;
  }
  
  if (confirm('Are you sure you want to delete ALL transactions? This cannot be undone.')) {
    state.transactions = [];
    LS.set('transactions', state.transactions);
    loadTransactions(); try{loadDashboardTransactions()}catch(e){}
    loadDashboard();
  }
}

function backupAllData() {
  // Include a dump of ALL localStorage keys (to capture Parts System too)
  const localStorageDump = {};
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    localStorageDump[k] = localStorage.getItem(k);
  }
  const dataWithLS = Object.assign({}, state, { localStorageDump });
  const dataStr = JSON.stringify(dataWithLS);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `esthetics_backup_${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
}

function restoreAllData(event) {
  if (state.currentUser.role !== 'admin') {
    alert('Only admin can restore data');
    return;
  }
  
  const file = event.target.files[0];
  if (!file) return;
  
  if (!confirm('Restoring data will overwrite ALL current data. Are you sure?')) {
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backupData = JSON.parse(e.target.result);
// Restore localStorage keys that are not the app's own core keys (to avoid double-setting)
const appKeys = ['transactions','categories','accounts','users','employees','payroll','advances','attendance','settings'];
if (backupData.localStorageDump){
  Object.entries(backupData.localStorageDump).forEach(([k,v])=>{
    if (!appKeys.includes(k)) {
      try { localStorage.setItem(k, v); } catch(e){ /* ignore quota errors */ }
    }
  });
}
      
      // Restore all data
      state.transactions = backupData.transactions || [];
      state.categories = backupData.categories || [];
      state.accounts = backupData.accounts || [];
      state.users = backupData.users || [];
      state.employees = backupData.employees || [];
      state.payroll = backupData.payroll || [];
      state.advances = backupData.advances || [];
      state.attendance = backupData.attendance || [];
      state.settings = backupData.settings || {};
      
      // Save to localStorage
      LS.set('transactions', state.transactions);
      LS.set('categories', state.categories);
      LS.set('accounts', state.accounts);
      LS.set('users', state.users);
      LS.set('employees', state.employees);
      LS.set('payroll', state.payroll);
      LS.set('advances', state.advances);
      LS.set('attendance', state.attendance);
      LS.set('settings', state.settings);
      
      alert('Data restored successfully!');
      loadAllData();
    } catch (err) {
      alert('Error restoring data: ' + err.message);
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

/* ---------- Export Functions ---------- */
function exportExcel() {
  const filteredTransactions = filterTransactions();
  
  if (filteredTransactions.length === 0) {
    alert('No transactions to export');
    return;
  }
  
  const data = filteredTransactions.map(t => ({
    Date: formatDisplayDate(t.date),
    Category: t.category,
    ID: t.transactionId || '',
    Vendor: t.vendor || '',
    Account: t.account,
    Amount: formatDisplayAmount(t.amount),
    Description: t.description || '',
    Type: t.type,
    'Created By': t.createdBy || 'anonymous',
    'Edited By': t.editedBy || ''
  }));
  
  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Transactions');
  XLSX.writeFile(workbook, `transactions_${new Date().toISOString().split('T')[0]}.xlsx`);
}



function exportPDF(){
  try{
    var { jsPDF } = window.jspdf || {};
    if(!jsPDF){ alert('jsPDF not available'); return; }
    var sd = document.getElementById('filterStart')?.value || '';
    var ed = document.getElementById('filterEnd')?.value || '';
    var cat = document.getElementById('filterCategory')?.value || '';
    var acc = document.getElementById('filterAccount')?.value || '';
    var typ = document.getElementById('filterType')?.value || '';

    function pass(txn){
      function inRange(d){
        var y=_asYMD(d);
        if(sd && (!y || y < _asYMD(sd))) return false;
        if(ed && (!y || y > _asYMD(ed))) return false;
        return true;
      }
      if(!inRange(txn.date)) return false;
      if(cat && String(txn.category||'')!==String(cat)) return false;
      if(acc && String(txn.account||'')!==String(acc)) return false;
      if(typ && String(txn.type||'')!==String(typ)) return false;
      return true;
    }
    var list = (state.transactions||[]).filter(pass);

    var income = 0, expense = 0, byAccount = {};
    list.forEach(function(t){
      var amt = Number(t.amount||0);
      if((t.type||'')==='income') income+=amt; else expense+=amt;
      var a = t.account||'Other'; byAccount[a]=(byAccount[a]||0)+amt*((t.type||'')==='income'?1:-1);
    });
    var net = income-expense;

    var doc = new jsPDF('p','pt','a4');
    doc.setFontSize(16);
    doc.text('Dashboard Summary (PDF)', 40, 40);
    doc.setFontSize(11);
    if(sd || ed) doc.text('Date range: ' + (sd||'...') + ' to ' + (ed||'...'), 40, 60);
    if(cat) doc.text('Category: ' + cat, 40, 75);
    if(acc) doc.text('Account: ' + acc, 200, 75);
    if(typ) doc.text('Type: ' + typ, 360, 75);

    var y=100;
    doc.setFontSize(12);
    doc.text('Income: AED ' + income.toFixed(2), 40, y); y+=20;
    doc.text('Expense: AED ' + expense.toFixed(2), 40, y); y+=20;
    doc.text('Net: AED ' + net.toFixed(2), 40, y); y+=30;

    var c = document.createElement('canvas'); c.width=500; c.height=220;
    var ctx = c.getContext('2d');
    var labels = Object.keys(byAccount);
    var data = labels.map(k=> Math.max(byAccount[k],0));
    if(labels.length>0){
      var chart = new Chart(ctx, { type:'pie', data:{ labels, datasets:[{ data }] }, options:{ responsive:false, plugins:{ legend:{display:true, position:'right'} } } });
      var img = c.toDataURL('image/png', 1.0);
      doc.addImage(img, 'PNG', 40, y, 500, 220);
      y += 240;
      try{ chart.destroy(); }catch(e){}
    }

    var rows = list.slice(0,25).map(t=>[t.date||'', t.category||'', t.transactionId||'', t.vendor||'', t.account||'', Number(t.amount||0).toFixed(2), t.type||'']);
    doc.autoTable({ startY:y, head:[['Date','Category','ID','Vendor','Account','Amount','Type']], body: rows, styles:{fontSize:9} });
    doc.save('dashboard_summary.pdf');
  }catch(e){ console.error('Dashboard PDF export failed', e); }
}



/* ---------- Employee Functions ---------- */
function loadEmployees() {
  // Load employee dropdowns
  const employeeDropdowns = [
    'advanceEmployee', 'attendanceEmployee', 'payrollEmployee', 'filterPayrollEmployee'
  ];
  
  employeeDropdowns.forEach(dropdownId => {
    const dropdown = document.getElementById(dropdownId);
    dropdown.innerHTML = '<option value="">Select Employee</option>';
    state.employees.forEach(emp => {
      if (emp.status === 'active') {
        dropdown.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
      }
    });
  });
  
  // Load employees table
  const tbody = document.querySelector('#employeesTable tbody');
  tbody.innerHTML = '';
  
  state.employees.forEach((emp, i) => {
    const visaExpiry = emp.visaExpiry ? new Date(emp.visaExpiry) : null;
    const passportExpiry = emp.passportExpiry ? new Date(emp.passportExpiry) : null;
    
    const today = new Date();
    let visaStatus = '';
    let passportStatus = '';
    
    if (visaExpiry) {
      const daysUntilExpiry = Math.floor((visaExpiry - today) / (1000 * 60 * 60 * 24));
      if (daysUntilExpiry < 0) visaStatus = 'status-inactive';
      else if (daysUntilExpiry < 30) visaStatus = 'status-warning';
      else visaStatus = 'status-active';
    }
    
    if (passportExpiry) {
      const daysUntilExpiry = Math.floor((passportExpiry - today) / (1000 * 60 * 60 * 24));
      if (daysUntilExpiry < 0) passportStatus = 'status-inactive';
      else if (daysUntilExpiry < 30) passportStatus = 'status-warning';
      else passportStatus = 'status-active';
    }
    
    tbody.innerHTML += `
      <tr>
        <td>${emp.name}</td>
        <td>${emp.position}</td>
        <td>${formatCurrency(emp.salary)}</td>
        <td class="${visaStatus}">${emp.visaExpiry ? formatDate(emp.visaExpiry) : 'N/A'}</td>
        <td class="${passportStatus}">${emp.passportExpiry ? formatDate(emp.passportExpiry) : 'N/A'}</td>
        <td class="${emp.status === 'active' ? 'status-active' : 'status-inactive'}">${emp.status}</td>
        <td>
          <button class="action-btn" onclick="viewEmployee(${i})"><i class="fa-solid fa-eye"></i></button>
          <button class="action-btn" onclick="editEmployee(${i})"><i class="fa-solid fa-pen"></i></button>
          <button class="action-btn" onclick="deleteEmployee(${i})"><i class="fa-solid fa-trash"></i></button>
        </td>
      </tr>
    `;
  });
  
  // Load visa reminders
  loadVisaReminders();
  
  // Load advances
  loadAdvances();
  
  // Load attendance
  loadAttendance();
  
  // Load payroll history
  loadPayrollHistory();
  
  // Populate year dropdowns
  populateYearDropdowns();
}

function populateYearDropdowns() {
  const currentYear = new Date().getFullYear();
  const yearDropdowns = [
    'payrollYear', 'filterAttendanceYear', 'filterPayrollYear'
  ];
  
  yearDropdowns.forEach(dropdownId => {
    const dropdown = document.getElementById(dropdownId);
    dropdown.innerHTML = '';
    
    for (let year = currentYear - 5; year <= currentYear + 1; year++) {
      dropdown.innerHTML += `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`;
    }
  });
}

function loadVisaReminders() {
  const visaRemindersEl = document.getElementById('visaReminders');
  const today = new Date();
  const warningEmployees = [];
  
  state.employees.forEach(emp => {
    if (emp.visaExpiry) {
      const expiryDate = new Date(emp.visaExpiry);
      const daysUntilExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
      
      if (daysUntilExpiry < 30) {
        warningEmployees.push({
          name: emp.name,
          expiry: emp.visaExpiry,
          days: daysUntilExpiry
        });
      }
    }
  });
  
  if (warningEmployees.length > 0) {
    visaRemindersEl.innerHTML = '<div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> Visa Expiry Reminders</div>';
    
    warningEmployees.forEach(emp => {
      const statusClass = emp.days < 0 ? 'status-inactive' : 'status-warning';
      visaRemindersEl.innerHTML += `
        <div class="visa-warning">
          <strong>${emp.name}</strong>: Visa expires on ${formatDate(emp.expiry)} 
          <span class="${statusClass}">(${emp.days < 0 ? 'Expired ' + Math.abs(emp.days) + ' days ago' : 'Expires in ' + emp.days + ' days'})</span>
        </div>
      `;
    });
  } else {
    visaRemindersEl.innerHTML = '<div class="card-title"><i class="fa-solid fa-check-circle"></i> No Visa Expiry Warnings</div>';
  }
}

function previewEmployeePhoto(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const preview = document.getElementById('empPhotoPreview');
      preview.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
}

document.getElementById('employeeForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const employee = {
    id: Date.now().toString(),
    name: document.getElementById('empName').value,
    position: document.getElementById('empPosition').value,
    phone: document.getElementById('empPhone').value,
    email: document.getElementById('empEmail').value,
    dob: document.getElementById('empDob').value,
    salary: parseFloat(document.getElementById('empSalary').value),
    housing: parseFloat(document.getElementById('empHousing').value) || 0,
    transport: parseFloat(document.getElementById('empTransport').value) || 0,
    other: parseFloat(document.getElementById('empOther').value) || 0,
    visa: document.getElementById('empVisa').value,
    visaExpiry: document.getElementById('empVisaExpiry').value,
    passport: document.getElementById('empPassport').value,
    passportExpiry: document.getElementById('empPassportExpiry').value,
    status: document.getElementById('empStatus').value,
    createdAt: new Date().toISOString(),
    createdBy: state.currentUser.username
  };
  
  // Handle photo upload
  const photoFile = document.getElementById('empPhoto').files[0];
  if (photoFile) {
    const reader = new FileReader();
    reader.onload = function(e) {
      employee.photo = e.target.result;
      saveEmployee(employee);
    };
    reader.readAsDataURL(photoFile);
  } else {
    saveEmployee(employee);
  }
});

function saveEmployee(employee) {
  state.employees.push(employee);
  LS.set('employees', state.employees);
  // Non-blocking notification and stay on Employees page
  try { showTransactionToast('Employee saved'); } catch(_) {}
  resetEmployeeForm();
  loadEmployees();
  try { showSection('employees'); } catch(_) {}
}

function resetEmployeeForm() {
  document.getElementById('employeeForm').reset();
  document.getElementById('empPhotoPreview').style.display = 'none';
  document.getElementById('empStatus').value = 'active';
}

function viewEmployee(index) {
  const emp = state.employees[index];
  
  let employeeDetails = `
    <strong>Name:</strong> ${emp.name}<br>
    <strong>Position:</strong> ${emp.position}<br>
    <strong>Salary:</strong> ${formatCurrency(emp.salary)}<br>
    <strong>Total Allowances:</strong> ${formatCurrency((emp.housing || 0) + (emp.transport || 0) + (emp.other || 0))}<br>
    <strong>Status:</strong> ${emp.status}<br>
  `;
  
  if (emp.phone) employeeDetails += `<strong>Phone:</strong> ${emp.phone}<br>`;
  if (emp.email) employeeDetails += `<strong>Email:</strong> ${emp.email}<br>`;
  if (emp.dob) employeeDetails += `<strong>DOB:</strong> ${formatDate(emp.dob)}<br>`;
  if (emp.visa) employeeDetails += `<strong>Visa #:</strong> ${emp.visa}<br>`;
  if (emp.visaExpiry) employeeDetails += `<strong>Visa Expiry:</strong> ${formatDate(emp.visaExpiry)}<br>`;
  if (emp.passport) employeeDetails += `<strong>Passport #:</strong> ${emp.passport}<br>`;
  if (emp.passportExpiry) employeeDetails += `<strong>Passport Expiry:</strong> ${formatDate(emp.passportExpiry)}<br>`;
  
  if (emp.photo) {
    employeeDetails += `<img src="${emp.photo}" class="employee-photo-preview" style="margin-top:10px;">`;
  }
  
  alert(employeeDetails);
}

function editEmployee(index) {
  const emp = state.employees[index];
  
  document.getElementById('empName').value = emp.name;
  document.getElementById('empPosition').value = emp.position;
  document.getElementById('empPhone').value = emp.phone || '';
  document.getElementById('empEmail').value = emp.email || '';
  document.getElementById('empDob').value = emp.dob || '';
  document.getElementById('empSalary').value = emp.salary;
  document.getElementById('empHousing').value = emp.housing || 0;
  document.getElementById('empTransport').value = emp.transport || 0;
  document.getElementById('empOther').value = emp.other || 0;
  document.getElementById('empVisa').value = emp.visa || '';
  document.getElementById('empVisaExpiry').value = emp.visaExpiry || '';
  document.getElementById('empPassport').value = emp.passport || '';
  document.getElementById('empPassportExpiry').value = emp.passportExpiry || '';
  document.getElementById('empStatus').value = emp.status;
  
  if (emp.photo) {
    const preview = document.getElementById('empPhotoPreview');
    preview.src = emp.photo;
    preview.style.display = 'block';
  }
  
  // Remove the old employee
  state.employees.splice(index, 1);
  LS.set('employees', state.employees);
  
  loadEmployees();
}

function deleteEmployee(index) {
  if (confirm('Are you sure you want to delete this employee?')) {
    state.employees.splice(index, 1);
    LS.set('employees', state.employees);
    loadEmployees();
  }
}

function exportEmployeesExcel() {
  if (state.employees.length === 0) {
    alert('No employees to export');
    return;
  }
  
  const data = state.employees.map(emp => ({
    Name: emp.name,
    Position: emp.position,
    'Phone Number': emp.phone || '',
    Email: emp.email || '',
    'Date of Birth': emp.dob ? formatDate(emp.dob) : '',
    'Basic Salary (AED)': emp.salary,
    'Housing Allowance (AED)': emp.housing || 0,
    'Transport Allowance (AED)': emp.transport || 0,
    'Other Allowance (AED)': emp.other || 0,
    'Visa Number': emp.visa || '',
    'Visa Expiry': emp.visaExpiry ? formatDate(emp.visaExpiry) : '',
    'Passport Number': emp.passport || '',
    'Passport Expiry': emp.passportExpiry ? formatDate(emp.passportExpiry) : '',
    Status: emp.status
  }));
  
  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Employees');
  XLSX.writeFile(workbook, `employees_${new Date().toISOString().split('T')[0]}.xlsx`);
}

function exportEmployeesPDF() {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) {
    alert('PDF library not loaded. Please refresh the page and try again.');
    return;
  }
  const doc = new jsPDF();
  
  // Add title
  doc.setFontSize(18);
  doc.text('Employees Report', 14, 15);
  
  // Add summary
  doc.setFontSize(10);
  doc.text(`Total Employees: ${state.employees.length}`, 14, 25);
  
  const activeEmployees = state.employees.filter(emp => emp.status === 'active').length;
  doc.text(`Active Employees: ${activeEmployees}`, 14, 32);
  
  // Add table
  const tableData = state.employees.map(emp => [
    emp.name,
    emp.position,
    formatCurrency(emp.salary),
    emp.visaExpiry ? formatDate(emp.visaExpiry) : 'N/A',
    emp.passportExpiry ? formatDate(emp.passportExpiry) : 'N/A',
    emp.status
  ]);
  
  doc.autoTable({
    startY: 40,
    head: [['Name', 'Position', 'Salary', 'Visa Expiry', 'Passport Expiry', 'Status']],
    body: tableData,
    theme: 'grid',
    headStyles: { fillColor: [11, 59, 109] },
    styles: { fontSize: 8 },
    margin: { left: 14, right: 14 }
  });
  
  // Save the PDF
  doc.save(`employees_report_${new Date().toISOString().split('T')[0]}.pdf`);
}

function exportEmployeeFullReport() {
  if (state.employees.length === 0) {
    alert('No employees to export');
    return;
  }
  
  const data = state.employees.map(emp => {
    const totalSalary = emp.salary + (emp.housing || 0) + (emp.transport || 0) + (emp.other || 0);
    
    return {
      Name: emp.name,
      Position: emp.position,
      'Phone Number': emp.phone || '',
      Email: emp.email || '',
      'Date of Birth': emp.dob ? formatDate(emp.dob) : '',
      'Basic Salary (AED)': emp.salary,
      'Housing Allowance (AED)': emp.housing || 0,
      'Transport Allowance (AED)': emp.transport || 0,
      'Other Allowance (AED)': emp.other || 0,
      'Total Salary (AED)': totalSalary,
      'Visa Number': emp.visa || '',
      'Visa Expiry': emp.visaExpiry ? formatDate(emp.visaExpiry) : '',
      'Passport Number': emp.passport || '',
      'Passport Expiry': emp.passportExpiry ? formatDate(emp.passportExpiry) : '',
      Status: emp.status,
      'Created By': emp.createdBy,
      'Created At': formatDateTime(emp.createdAt)
    };
  });
  
  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Employees Full Report');
  XLSX.writeFile(workbook, `employees_full_report_${new Date().toISOString().split('T')[0]}.xlsx`);
}

/* ---------- Advance Management ---------- */
function addAdvance() {
  const employeeId = document.getElementById('advanceEmployee').value;
  const date = document.getElementById('advanceDate').value;
  const amount = parseFloat(document.getElementById('advanceAmount').value);
  const reason = document.getElementById('advanceReason').value;
  
  if (!employeeId || !date || !amount) {
    alert('Please select employee, enter date and amount');
    return;
  }
  
  const employee = state.employees.find(emp => emp.id === employeeId);
  if (!employee) {
    alert('Employee not found');
    return;
  }
  
  const advance = {
    id: Date.now().toString(),
    employeeId,
    employeeName: employee.name,
    date,
    amount,
    reason,
    status: 'pending',
    createdAt: new Date().toISOString(),
    createdBy: state.currentUser.username
  };
  
  state.advances.push(advance);
  LS.set('advances', state.advances);
  
  alert('Advance added successfully!');
  const advanceTransaction = {
  date: date,
  category: 'Staff',
  transactionId: 'Advance',
  vendor: employee.name,
  account: 'Cash',
  amount: amount,
  description: reason ? `Advance for ${employee.name}: ${reason}` : `Advance for ${employee.name}`,
  type: 'expense',
  createdAt: advance.createdAt,
  createdBy: state.currentUser.username
};
state.transactions.push(advanceTransaction);
LS.set('transactions', state.transactions);
  document.getElementById('advanceAmount').value = '';
  document.getElementById('advanceReason').value = '';
  document.getElementById('advanceDate').value = new Date().toISOString().split('T')[0];
  
  loadAdvances();
}

function loadAdvances() {
  const tbody = document.querySelector('#advancesTable tbody');
  tbody.innerHTML = '';
  
  state.advances.forEach((adv, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${formatDate(adv.date)}</td>
        <td>${adv.employeeName}</td>
        <td>${formatCurrency(adv.amount)}</td>
        <td>${adv.reason || '-'}</td>
        <td class="${adv.status === 'paid' ? 'advance-paid' : 'advance-pending'}">${adv.status}</td>
        <td>
          ${adv.status === 'pending' ? `
            <button class="action-btn" onclick="markAdvancePaid(${i})"><i class="fa-solid fa-check"></i> Mark Paid</button>
          ` : ''}
          <button class="action-btn" onclick="deleteAdvance(${i})"><i class="fa-solid fa-trash"></i></button>
        </td>
      </tr>
    `;
  });
}

function markAdvancePaid(index) {
  state.advances[index].status = 'paid';
  LS.set('advances', state.advances);
  loadAdvances();
}

function deleteAdvance(index) {
  if (confirm('Are you sure you want to delete this advance record?')) {
    state.advances.splice(index, 1);
    LS.set('advances', state.advances);
    loadAdvances();
  }
}

/* ---------- Attendance Management ---------- */
function markAttendance() {
  const employeeId = document.getElementById('attendanceEmployee').value;
  const date = document.getElementById('attendanceDate').value;
  const status = document.getElementById('attendanceStatus').value;
  const notes = document.getElementById('attendanceNotes').value;
  
  if (!employeeId || !date) {
    alert('Please select employee and enter date');
    return;
  }
  
  const employee = state.employees.find(emp => emp.id === employeeId);
  if (!employee) {
    alert('Employee not found');
    return;
  }
  
  // Check if attendance already exists for this employee on this date
  const existingIndex = state.attendance.findIndex(a => a.employeeId === employeeId && a.date === date);
  
  const attendance = {
    id: existingIndex === -1 ? Date.now().toString() : state.attendance[existingIndex].id,
    employeeId,
    employeeName: employee.name,
    date,
    status,
    notes,
    updatedAt: new Date().toISOString(),
    updatedBy: state.currentUser.username
  };
  
  if (existingIndex === -1) {
    state.attendance.push(attendance);
  } else {
    state.attendance[existingIndex] = attendance;
  }
  
  LS.set('attendance', state.attendance);
  
  alert('Attendance marked successfully!');
  document.getElementById('attendanceNotes').value = '';
  document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
  
  loadAttendance();
}

function loadAttendance() {
  const month = document.getElementById('filterAttendanceMonth').value;
  const year = document.getElementById('filterAttendanceYear').value;
  
  let filteredAttendance = state.attendance;
  
  if (month && year) {
    filteredAttendance = state.attendance.filter(a => {
      const [aYear, aMonth] = a.date.split('-');
      return aYear === year && aMonth === month.padStart(2, '0');
    });
  }
  
  const tbody = document.querySelector('#attendanceTable tbody');
  tbody.innerHTML = '';
  
  filteredAttendance.forEach((att, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${formatDate(att.date)}</td>
        <td>${att.employeeName}</td>
        <td class="${att.status === 'present' ? 'attendance-present' : att.status === 'absent' ? 'attendance-absent' : 'attendance-leave'}">${att.status}</td>
        <td>${att.notes || '-'}</td>
        <td>
          <button class="action-btn" onclick="editAttendance(${i})"><i class="fa-solid fa-pen"></i></button>
          <button class="action-btn" onclick="deleteAttendance(${i})"><i class="fa-solid fa-trash"></i></button>
        </td>
      </tr>
    `;
  });
}

function editAttendance(index) {
  const att = state.attendance[index];
  
  document.getElementById('attendanceEmployee').value = att.employeeId;
  document.getElementById('attendanceDate').value = att.date;
  document.getElementById('attendanceStatus').value = att.status;
  document.getElementById('attendanceNotes').value = att.notes || '';
  
  // Remove the old attendance record
  state.attendance.splice(index, 1);
  LS.set('attendance', state.attendance);
  
  loadAttendance();
}

function deleteAttendance(index) {
  if (confirm('Are you sure you want to delete this attendance record?')) {
    state.attendance.splice(index, 1);
    LS.set('attendance', state.attendance);
    loadAttendance();
  }
}

function exportAttendancePDF() {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) {
    alert('PDF library not loaded. Please refresh the page and try again.');
    return;
  }
  const doc = new jsPDF();
  
  const month = document.getElementById('filterAttendanceMonth').value;
  const year = document.getElementById('filterAttendanceYear').value;
  
  let filteredAttendance = state.attendance;
  let title = 'Attendance Report - All Time';
  
  if (month && year) {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    title = `Attendance Report - ${monthNames[parseInt(month) - 1]} ${year}`;
    
    filteredAttendance = state.attendance.filter(a => {
      const [aYear, aMonth] = a.date.split('-');
      return aYear === year && aMonth === month.padStart(2, '0');
    });
  }
  
  // Add title
  doc.setFontSize(18);
  doc.text(title, 14, 15);
  
  // Add summary
  const presentCount = filteredAttendance.filter(a => a.status === 'present').length;
  const absentCount = filteredAttendance.filter(a => a.status === 'absent').length;
  const leaveCount = filteredAttendance.filter(a => a.status === 'leave').length;
  const halfDayCount = filteredAttendance.filter(a => a.status === 'half-day').length;
  
  doc.setFontSize(10);
  doc.text(`Total Records: ${filteredAttendance.length}`, 14, 25);
  doc.text(`Present: ${presentCount}`, 14, 32);
  doc.text(`Absent: ${absentCount}`, 14, 39);
  doc.text(`Leave: ${leaveCount}`, 14, 46);
  doc.text(`Half Day: ${halfDayCount}`, 14, 53);
  
  // Add table
  const tableData = filteredAttendance.map(att => [
    formatDate(att.date),
    att.employeeName,
    att.status,
    att.notes || '-'
  ]);
  
  doc.autoTable({
    startY: 60,
    head: [['Date', 'Employee', 'Status', 'Notes']],
    body: tableData,
    theme: 'grid',
    headStyles: { fillColor: [11, 59, 109] },
    styles: { fontSize: 8 },
    margin: { left: 14, right: 14 }
  });
  
  // Save the PDF
  doc.save(`attendance_report_${new Date().toISOString().split('T')[0]}.pdf`);
}

/* ---------- Payroll Management ---------- */
function calculateSalary() {
  const employeeId = document.getElementById('payrollEmployee').value;
  const month = document.getElementById('payrollMonth').value;
  const year = document.getElementById('payrollYear').value;
  const deductions = parseFloat(document.getElementById('payrollDeductions').value) || 0;
  const bonus = parseFloat(document.getElementById('payrollBonus').value) || 0;
  
  if (!employeeId || !month || !year) {
    alert('Please select employee, month and year');
    return;
  }
  
  const employee = state.employees.find(emp => emp.id === employeeId);
  if (!employee) {
    alert('Employee not found');
    return;
  }
  
  // Check if payroll already processed for this employee for this month/year
  const existingPayroll = state.payroll.find(p => 
    p.employeeId === employeeId && p.month === month && p.year === year
  );
  
  if (existingPayroll) {
    if (!confirm('Payroll already processed for this month. Do you want to recalculate?')) {
      return;
    }
  }
  
  // Calculate basic salary and allowances
  const basicSalary = employee.salary;
  const housing = employee.housing || 0;
  const transport = employee.transport || 0;
  const other = employee.other || 0;
  const totalAllowances = housing + transport + other;
  
  // Calculate attendance deductions
  const attendanceDays = state.attendance.filter(a => 
    a.employeeId === employeeId && 
    a.date.startsWith(`${year}-${month.padStart(2, '0')}`) &&
    a.status === 'absent'
  ).length;
  
  const attendanceDeduction = (basicSalary / 30) * attendanceDays;
  
  // Calculate advance deductions
  const advanceDeductions = state.advances.filter(a => 
    a.employeeId === employeeId && 
    a.status === 'pending'
  ).reduce((sum, advance) => sum + advance.amount, 0);
  
  // Total deductions
  const totalDeductions = deductions + attendanceDeduction + advanceDeductions;
  
  // Net salary
  const netSalary = basicSalary + totalAllowances + bonus - totalDeductions;
  
  // Display salary preview
  const salaryPreview = document.getElementById('salaryPreview');
  const salaryDetails = document.getElementById('salaryDetails');
  
  salaryDetails.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div><strong>Employee:</strong> ${employee.name}</div>
      <div><strong>Position:</strong> ${employee.position}</div>
      <div><strong>Basic Salary:</strong> ${formatCurrency(basicSalary)}</div>
      <div><strong>Total Allowances:</strong> ${formatCurrency(totalAllowances)}</div>
      <div><strong>Bonus:</strong> ${formatCurrency(bonus)}</div>
      <div><strong>Attendance Deduction (${attendanceDays} days):</strong> ${formatCurrency(attendanceDeduction)}</div>
      <div><strong>Advance Deductions:</strong> ${formatCurrency(advanceDeductions)}</div>
      <div><strong>Other Deductions:</strong> ${formatCurrency(deductions)}</div>
      <div><strong>Total Deductions:</strong> ${formatCurrency(totalDeductions)}</div>
      <div><strong>Net Salary:</strong> ${formatCurrency(netSalary)}</div>
    </div>
  `;
  
  salaryPreview.style.display = 'block';
  
  // Enable process payment button
  document.getElementById('processPaymentBtn').disabled = false;
  document.getElementById('generateSlipBtn').disabled = false;
  
  // Store calculated salary data for processing
  window.calculatedSalary = {
    employeeId,
    employeeName: employee.name,
    month,
    year,
    basicSalary,
    housing,
    transport,
    other,
    totalAllowances,
    bonus,
    deductions,
    attendanceDeduction,
    advanceDeductions,
    totalDeductions,
    netSalary,
    attendanceDays
  };
}

function processPayment() {
  if (!window.calculatedSalary) {
    alert('Please calculate salary first');
    return;
  }
  
  const payroll = {
    id: Date.now().toString(),
    ...window.calculatedSalary,
    paymentDate: document.getElementById('payrollDate').value,
    deductionReason: document.getElementById('deductionReason').value || '',
    bonusReason: document.getElementById('bonusReason').value || '',
    processedAt: new Date().toISOString(),
    processedBy: state.currentUser.username
  };
  
  // Check if payroll already exists for this month
  const existingIndex = state.payroll.findIndex(p => 
    p.employeeId === payroll.employeeId && p.month === payroll.month && p.year === payroll.year
  );
  
  if (existingIndex !== -1) {
    state.payroll[existingIndex] = payroll;
  } else {
    state.payroll.push(payroll);
  }
  
  // Mark advances as paid
  state.advances.forEach(advance => {
    if (advance.employeeId === payroll.employeeId && advance.status === 'pending') {
      advance.status = 'paid';
    }
  });
  
  LS.set('payroll', state.payroll);
  LS.set('advances', state.advances);
  
  alert('Payment processed successfully!');
  const salaryTransaction = {
  date: payroll.paymentDate,
  category: 'Staff',
  transactionId: 'Salary',
  vendor: payroll.employeeName,
  account: 'Cash',
  amount: payroll.netSalary,
  description: `Salary paid for ${payroll.employeeName}, ${payroll.month}/${payroll.year}`,
  type: 'expense',
  createdAt: payroll.processedAt,
  createdBy: state.currentUser.username
};
state.transactions.push(salaryTransaction);
LS.set('transactions', state.transactions);
  
  // Reset form
  document.getElementById('payrollDeductions').value = '0';
  document.getElementById('deductionReason').value = '';
  document.getElementById('payrollBonus').value = '0';
  document.getElementById('bonusReason').value = '';
  document.getElementById('processPaymentBtn').disabled = true;
  document.getElementById('generateSlipBtn').disabled = true;
  document.getElementById('salaryPreview').style.display = 'none';
  
  // Reload data
  loadPayrollHistory();
  loadAdvances();
}

function generateSalarySlip() {
  if (!window.calculatedSalary) {
    alert('Please calculate salary first');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const salary = window.calculatedSalary;
  const employee = state.employees.find(emp => emp.id === salary.employeeId);
  
  // Add company header
  doc.setFontSize(16);
  doc.text(state.settings.companyName || 'Esthetics Auto', 105, 15, { align: 'center' });
  doc.setFontSize(10);
  doc.text(state.settings.companyAddress || 'Dubai, UAE', 105, 22, { align: 'center' });
  
  // Add title
  doc.setFontSize(14);
  doc.text('SALARY SLIP', 105, 32, { align: 'center' });
  
  // Add period
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  doc.setFontSize(10);
  doc.text(`For the month of ${monthNames[parseInt(salary.month) - 1]} ${salary.year}`, 105, 39, { align: 'center' });
  
  // Employee details
  doc.setFontSize(12);
  doc.text('Employee Details:', 14, 50);
  doc.setFontSize(10);
  doc.text(`Name: ${employee.name}`, 20, 57);
  doc.text(`Position: ${employee.position}`, 20, 64);
  doc.text(`Payment Date: ${formatDate(document.getElementById('payrollDate').value)}`, 20, 71);
  
  // Salary details
  doc.setFontSize(12);
  doc.text('Earnings:', 14, 82);
  doc.setFontSize(10);
  doc.text(`Basic Salary: ${formatCurrency(salary.basicSalary)}`, 20, 89);
  doc.text(`Housing Allowance: ${formatCurrency(salary.housing)}`, 20, 96);
  doc.text(`Transport Allowance: ${formatCurrency(salary.transport)}`, 20, 103);
  doc.text(`Other Allowance: ${formatCurrency(salary.other)}`, 20, 110);
  doc.text(`Bonus: ${formatCurrency(salary.bonus)}`, 20, 117);
  
  doc.setFontSize(12);
  doc.text('Deductions:', 14, 128);
  doc.setFontSize(10);
  doc.text(`Attendance (${salary.attendanceDays} days): ${formatCurrency(salary.attendanceDeduction)}`, 20, 135);
  doc.text(`Advance Deductions: ${formatCurrency(salary.advanceDeductions)}`, 20, 142);
  doc.text(`Other Deductions: ${formatCurrency(salary.deductions)}`, 20, 149);
  
  // Net salary
  doc.setFontSize(12);
  doc.text(`Net Salary: ${formatCurrency(salary.netSalary)}`, 14, 160);
  
  // Footer
  doc.setFontSize(8);
  doc.text('This is a computer generated document and does not require a signature.', 105, 180, { align: 'center' });
  doc.text(`Generated on: ${formatDateTime(new Date())} by ${state.currentUser.username}`, 105, 187, { align: 'center' });
  
  // Save the PDF
  doc.save(`salary_slip_${employee.name}_${salary.month}_${salary.year}.pdf`);
}

function loadPayrollHistory() {
  const employeeId = document.getElementById('filterPayrollEmployee').value;
  const month = document.getElementById('filterPayrollMonth').value;
  const year = document.getElementById('filterPayrollYear').value;
  
  let filteredPayroll = state.payroll;
  
  if (employeeId) {
    filteredPayroll = filteredPayroll.filter(p => p.employeeId === employeeId);
  }
  
  if (month) {
    filteredPayroll = filteredPayroll.filter(p => p.month === month);
  }
  
  if (year) {
    filteredPayroll = filteredPayroll.filter(p => p.year === year);
  }
  
  const tbody = document.querySelector('#payrollHistoryTable tbody');
  tbody.innerHTML = '';
  
  filteredPayroll.forEach((p, i) => {
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    tbody.innerHTML += `
      <tr>
        <td>${formatDate(p.paymentDate)}</td>
        <td>${p.employeeName}</td>
        <td>${monthNames[parseInt(p.month) - 1]} ${p.year}</td>
        <td>${formatCurrency(p.basicSalary)}</td>
        <td>${formatCurrency(p.totalAllowances)}</td>
        <td>${formatCurrency(p.totalDeductions)}</td>
        <td>${formatCurrency(p.bonus)}</td>
        <td>${formatCurrency(p.netSalary)}</td>
        <td>
          <button class="action-btn" onclick="viewPayrollDetails(${i})"><i class="fa-solid fa-eye"></i></button>
          <button class="action-btn" onclick="deletePayroll(${i})"><i class="fa-solid fa-trash"></i></button>
        </td>
      </tr>
    `;
  });
}

function filterPayrollHistory() {
  loadPayrollHistory();
}

function viewPayrollDetails(index) {
  const payroll = state.payroll[index];
  
  let details = `
    <strong>Employee:</strong> ${payroll.employeeName}<br>
    <strong>Period:</strong> ${payroll.month}/${payroll.year}<br>
    <strong>Payment Date:</strong> ${formatDate(payroll.paymentDate)}<br>
    <strong>Basic Salary:</strong> ${formatCurrency(payroll.basicSalary)}<br>
    <strong>Housing Allowance:</strong> ${formatCurrency(payroll.housing)}<br>
    <strong>Transport Allowance:</strong> ${formatCurrency(payroll.transport)}<br>
    <strong>Other Allowance:</strong> ${formatCurrency(payroll.other)}<br>
    <strong>Total Allowances:</strong> ${formatCurrency(payroll.totalAllowances)}<br>
    <strong>Bonus:</strong> ${formatCurrency(payroll.bonus)}<br>
    <strong>Attendance Deduction (${payroll.attendanceDays} days):</strong> ${formatCurrency(payroll.attendanceDeduction)}<br>
    <strong>Advance Deductions:</strong> ${formatCurrency(payroll.advanceDeductions)}<br>
    <strong>Other Deductions:</strong> ${formatCurrency(payroll.deductions)}<br>
    <strong>Total Deductions:</strong> ${formatCurrency(payroll.totalDeductions)}<br>
    <strong>Net Salary:</strong> ${formatCurrency(payroll.netSalary)}<br>
  `;
  
  if (payroll.deductionReason) {
    details += `<strong>Deduction Reason:</strong> ${payroll.deductionReason}<br>`;
  }
  
  if (payroll.bonusReason) {
    details += `<strong>Bonus Reason:</strong> ${payroll.bonusReason}<br>`;
  }
  
  details += `<strong>Processed By:</strong> ${payroll.processedBy}<br>`;
  details += `<strong>Processed At:</strong> ${formatDateTime(payroll.processedAt)}<br>`;
  
  alert(details);
}

function deletePayroll(index) {
  if (confirm('Are you sure you want to delete this payroll record?')) {
    state.payroll.splice(index, 1);
    LS.set('payroll', state.payroll);
    loadPayrollHistory();
  }
}

/* ---------- Import Excel Data ---------- */
function importExcelData(event) {
  if (state.currentUser.role !== 'admin') {
    alert('Only admin can import data');
    return;
  }
  
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      
      // Get first worksheet
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(worksheet);
      
      if (jsonData.length === 0) {
        alert('No data found in the Excel file');
        return;
      }
      
      let importedCount = 0;
      let skippedCount = 0;
      
      jsonData.forEach(row => {
        // Validate required fields
        if (!row.Date || !row.Category || !row.Account || !row.Amount || !row.Type) {
          skippedCount++;
          return;
        }
        
        // Convert date from DD-MM-YYYY to YYYY-MM-DD
        let dateFormatted;
        if (typeof row.Date === 'string' && row.Date.includes('-')) {
          const [day, month, year] = row.Date.split('-');
          dateFormatted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        } else if (row.Date instanceof Date) {
          dateFormatted = row.Date.toISOString().split('T')[0];
        } else {
          skippedCount++;
          return;
        }
        
        // Check if category exists, if not add it
        if (!state.categories.includes(row.Category)) {
          state.categories.push(row.Category);
        }
        
        // Check if account exists, if not add it
        if (!state.accounts.includes(row.Account)) {
          state.accounts.push(row.Account);
        }
        
        const transaction = {
          date: dateFormatted,
          category: row.Category,
          transactionId: row.ID || '',
          vendor: row.Vendor || '',
          account: row.Account,
          amount: parseFloat(row.Amount),
          description: row.Description || '',
          type: row.Type.toLowerCase(),
          createdAt: new Date().toISOString(),
          createdBy: state.currentUser.username
        };
        
        state.transactions.push(transaction);
        importedCount++;
      });
      
      // Save updated data
      LS.set('transactions', state.transactions);
      LS.set('categories', state.categories);
      LS.set('accounts', state.accounts);
      
      alert(`Import completed: ${importedCount} transactions imported, ${skippedCount} skipped`);
      
      // Reload data
      loadTransactions(); try{loadDashboardTransactions()}catch(e){}
      loadDashboard();
      
    } catch (err) {
      alert('Error importing Excel file: ' + err.message);
    }
    event.target.value = '';
  };
  reader.readAsArrayBuffer(file);
}

/* ---------- Utility Functions ---------- */
function formatCurrency(amount) {
  return new Intl.NumberFormat('en-AE', { 
    style: 'currency', 
    currency: 'AED',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(amount);
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-GB');
}

function formatDateTime(dateTimeString) {
  const date = new Date(dateTimeString);
  return date.toLocaleString('en-GB');
}

function loadAllData() {
  // Populate category and account dropdowns
  updateCategoryDropdown();
  updateAccountDropdown();
  
  // Set default date to today (allow future dates)
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('date');
  if (dateInput) {
    dateInput.value = today;
    // Remove max restriction to allow future dates
    // dateInput.setAttribute('max', today);
  }
  
  // Firestore disabled: rely on native snapshot + localStorage only
  
  // Always load transactions and dashboard data regardless of visible section
  try {
    loadTransactions(); 
    loadDashboardTransactions();
    loadDashboard();
  } catch(e) {
    console.error('Error loading transactions:', e);
  }
  
  // Load employees if on employees page
  if (document.getElementById('employeesSection').classList.contains('hidden') === false) {
    loadEmployees();
  }
  
  // Load settings if on settings page
  if (document.getElementById('settingsSection').classList.contains('hidden') === false) {
    loadSettings();
  }
}

// Debug initialization
console.log('🚀 Starting app initialization...');
console.log('📊 Initial state check:', {
  categories: state.categories.length,
  accounts: state.accounts.length,
  transactions: state.transactions.length,
  hasNativeStorage: !!window.nativeStorage,
  hasLocalStorage: !!window.localStorage
});

// Initialize the app
console.log('📖 Loading native snapshot...');
loadNativeSnapshot().finally(() => {
  console.log('✅ Native snapshot loaded, starting main app...');
  // Force reload of transactions from localStorage and update UI
  state.transactions = LS.get('transactions', []);
  loadAllData();
  try { clearFilters(true); } catch(e) { console.warn('clearFilters on init failed', e); }
  console.log('🎉 App initialization complete!');
});
</script>

<!-- Enhanced Storage System - Load AFTER main app -->


<!-- Initialize Enhanced Storage -->
<script>
// Wait for main app to initialize first
setTimeout(() => {
  console.log('🔧 Enhanced Storage initialized after main app');
  
  // Test storage immediately
  if (window.testDataStorage) {
    window.testDataStorage();
  }
  
  // Show debug info
  console.log('📊 Storage Status:', window.UnifiedStorage ? window.UnifiedStorage.getStorageInfo() : 'Not loaded');
}, 2000);
</script>

<script>
// Toggle Type buttons -> sync with hidden select
function setTxnType(type){
  try{
    var sel = document.getElementById('transactionType');
    if(!sel) return;
    sel.value = type;
    var incomeBtn = document.getElementById('btnTypeIncome');
    var expenseBtn = document.getElementById('btnTypeExpense');
    if(incomeBtn && expenseBtn){
      incomeBtn.classList.toggle('active', type === 'income');
      expenseBtn.classList.toggle('active', type === 'expense');
    }
  }catch(e){ console.error('setTxnType error', e); }
}

(function(){
  // Enforce Vehicle ID requirement
  function enforceVehicleIdRequirement(){
    var cat = document.getElementById('category');
    var idf = document.getElementById('transactionId');
    if(!cat || !idf) return;
    var v = (cat.value || '').trim().toLowerCase();
    var isVeh = (v === 'vehicle') || (v === 'vehicles') || v.indexOf('vehicle') !== -1;
    if(isVeh){
      idf.required = true;
      if(idf.placeholder !== 'Vehicle ID is required'){
        idf.setAttribute('data-old-placeholder', idf.placeholder || '');
      }
      idf.placeholder = 'Vehicle ID is required';
      idf.title = 'Please enter Vehicle ID';
    }else{
      idf.required = false;
      var old = idf.getAttribute('data-old-placeholder');
      idf.placeholder = old !== null ? old : 'Optional';
      idf.removeAttribute('data-old-placeholder');
      idf.removeAttribute('title');
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Initialize Type toggle state from hidden select (default income if empty)
    var sel = document.getElementById('transactionType');
    var val = (sel && sel.value) ? sel.value : 'income';
    setTxnType(val);

    // Bind Vehicle ID requirement
    var cat = document.getElementById('category');
    if(cat){
      enforceVehicleIdRequirement();
      cat.addEventListener('change', enforceVehicleIdRequirement);
    }
  });
})();

// ---- Vehicle Report ----
function _coerceNumber(n){ var x = parseFloat(n); return isNaN(x) ? 0 : x; }
function _text(el){ return (el && (el.textContent||'')).trim(); }

function getAllTransactionsSafe(){
  try{
    if (Array.isArray(window.transactions) && window.transactions.length){
      return window.transactions.map(x => ({
        date: x.date || x.Date || '',
        category: (x.category || x.Category || '').toString(),
        id: (x.id || x.ID || x.transactionId || x.TransactionId || '').toString(),
        vendor: x.vendor || x.Vendor || '',
        account: x.account || x.Account || '',
        amount: parseFloat(x.amount || x.Amount) || 0,
        description: x.description || x.Description || '',
        type: (x.type || x.Type || '').toString().toLowerCase()
      }));
    }
  }catch(e){}

  try{
    var raw = localStorage.getItem('transactions');
    if (raw){
      var arr = JSON.parse(raw);
      if (Array.isArray(arr)){
        return arr.map(x => ({
          date: x.date || x.Date || '',
          category: (x.category || x.Category || '').toString(),
          id: (x.id || x.ID || x.transactionId || x.TransactionId || '').toString(),
          vendor: x.vendor || x.Vendor || '',
          account: x.account || x.Account || '',
          amount: parseFloat(x.amount || x.Amount) || 0,
          description: x.description || x.Description || '',
          type: (x.type || x.Type || '').toString().toLowerCase()
        }));
      }
    }
  }catch(e){}

  try{
    var rows = Array.from(document.querySelectorAll('#transactionsTable tbody tr'));
    if (rows.length){
      return rows.map(tr => {
        var tds = tr.querySelectorAll('td');
        return {
          date: (tds[0]?.textContent||'').trim(),
          category: (tds[1]?.textContent||'').trim(),
          id: (tds[2]?.textContent||'').trim(),
          vendor: (tds[3]?.textContent||'').trim(),
          account: (tds[4]?.textContent||'').trim(),
          amount: parseFloat((tds[5]?.textContent||'').trim()) || 0,
          description: (tds[6]?.textContent||'').trim(),
          type: (tds[7]?.textContent||'').trim().toLowerCase()
        };
      });
    }
  }catch(e){}

  return [];
}


function filterVehicleTransactions(vehicleId, startDate, endDate){
  var all = getAllTransactionsSafe();
  var vid = (vehicleId||'').trim().toLowerCase();
  function normalizeDate(s){
    if(!s) return null;
    s = String(s).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { return s; }
    if (/^\d{2}-\d{2}-\d{4}$/.test(s)) { var p=s.split('-'); return p[2]+'-'+p[1]+'-'+p[0]; }
    return s;
  }
  var sDate = normalizeDate(startDate);
  var eDate = normalizeDate(endDate);

  return all.filter(function(txn){
    var cat = (txn.category||'').toString().trim().toLowerCase();
    var idVal = (txn.id||'').toString().trim().toLowerCase();
    var isVehicle = cat === 'vehicle' || cat === 'vehicles' || cat.indexOf('vehicle') !== -1;
    if(!isVehicle) return false;
    if (vid && idVal !== vid) return false;
    var tDate = normalizeDate(txn.date||'');
    if (sDate && (!tDate || tDate < sDate)) return false;
    if (eDate && (!tDate || tDate > eDate)) return false;
    return true;
  }).sort(function(a,b){
    var ad = (a.date||''); var bd = (b.date||'');
    if (ad === bd) return (b.amount||0) - (a.amount||0);
    return ad > bd ? -1 : 1;
  });
}


function renderVehicleSummary(list){
  var income = 0, expense = 0;
  list.forEach(x => {
    if((x.type||'') === 'income') income += x.amount;
    else expense += x.amount;
  });
  var net = income - expense;
  var host = document.getElementById('vrSummary');
  if(!host) return;
  host.innerHTML = '';

  function card(title, val, cls){
    var div = document.createElement('div');
    div.className = 'vr-card';
    var t = document.createElement('div'); t.className = 'vr-title'; t.textContent = title;
    var v = document.createElement('div'); v.className = 'vr-value ' + (cls||''); v.textContent = val;
    div.appendChild(t); div.appendChild(v);
    return div;
  }
  host.appendChild(card('Total Income', 'AED ' + income.toFixed(2), 'positive-amount'));
  host.appendChild(card('Total Expense', 'AED ' + expense.toFixed(2), 'negative-amount'));
  host.appendChild(card('Net', 'AED ' + net.toFixed(2), net>=0 ? 'positive-amount' : 'negative-amount'));
  host.appendChild(card('Transactions', String(list.length)));
}

function renderVehicleTable(list){
  var tbody = document.querySelector('#vehicleReportTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  list.forEach(x => {
    var tr = document.createElement('tr');
    function td(txt){ var d=document.createElement('td'); d.textContent = txt; return d; }
    tr.appendChild(td(x.date||''));
    tr.appendChild(td(x.category||''));
    tr.appendChild(td(x.id||''));
    tr.appendChild(td(x.vendor||''));
    tr.appendChild(td(x.account||''));
    tr.appendChild(td((x.amount!=null? x.amount.toFixed(2):'') ));
    tr.appendChild(td(x.description||''));
    tr.appendChild(td((x.type||'').charAt(0).toUpperCase() + (x.type||'').slice(1)));
    tbody.appendChild(tr);
  });
}


function runVehicleReport(){
  var input = document.getElementById('vrVehicleId');
  var vid = input ? input.value : '';
  var sd = document.getElementById('vrStartDate') ? document.getElementById('vrStartDate').value : '';
  var ed = document.getElementById('vrEndDate') ? document.getElementById('vrEndDate').value : '';
  var list = filterVehicleTransactions(vid, sd, ed);
  renderVehicleSummary(list);
  renderVehicleTable(list);
}


function clearVehicleReport(){
  var input = document.getElementById('vrVehicleId');
  if(input) input.value='';
  renderVehicleSummary([]);
  renderVehicleTable([]);
}


function exportVehicleReportExcel(){
  try{
    var vid = (document.getElementById('vrVehicleId')?.value||'').trim();
    var sd = document.getElementById('vrStartDate')?.value || '';
    var ed = document.getElementById('vrEndDate')?.value || '';
    var list = filterVehicleTransactions(vid, sd, ed);

    var rows = [['Date','Category','Vehicle ID','Vendor','Account','Amount (AED)','Description','Type','Income','Expense']];
    var incomeTotal = 0, expenseTotal = 0;
    list.forEach(function(t){
      var income = (t.type==='income') ? Number(t.amount||0) : 0;
      var expense = (t.type==='income') ? 0 : Number(t.amount||0);
      incomeTotal += income; expenseTotal += expense;
      rows.push([t.date||'', t.category||'', t.id||'', t.vendor||'', t.account||'', Number(t.amount||0)||0, t.description||'', t.type||'', income, expense]);
    });
    var profit = incomeTotal - expenseTotal;

    var wb = XLSX.utils.book_new();
    var ws1 = XLSX.utils.aoa_to_sheet(rows);
    var ws2 = XLSX.utils.aoa_to_sheet([
      ['Vehicle', vid || 'All Vehicles'],
      ['Start Date', sd || '-'],
      ['End Date', ed || '-'],
      ['Total Income (AED)', incomeTotal],
      ['Total Expense (AED)', expenseTotal],
      ['Net / Profit (AED)', profit],
      ['Transactions Count', list.length]
    ]);
    XLSX.utils.book_append_sheet(wb, ws1, 'Transactions');
    XLSX.utils.book_append_sheet(wb, ws2, 'Summary');
    XLSX.writeFile(wb, 'vehicle_report_detailed.xlsx');
  }catch(e){ console.error('Excel export failed', e); }
}




function exportVehicleReportPDF(){
  try{
    var { jsPDF } = window.jspdf || {};
    if(!jsPDF){ alert('jsPDF not available'); return; }
    var vid = (document.getElementById('vrVehicleId')?.value||'').trim();
    var sd = document.getElementById('vrStartDate')?.value || '';
    var ed = document.getElementById('vrEndDate')?.value || '';
    var list = filterVehicleTransactions(vid, sd, ed);

    var income = 0, expense = 0;
    list.forEach(x => { if((x.type||'')==='income') income+=Number(x.amount||0); else expense+=Number(x.amount||0); });
    var net = income - expense;

    var doc = new jsPDF('p', 'pt', 'a4');
    doc.setFontSize(16);
    doc.text('Vehicle Summary Report', 40, 40);
    doc.setFontSize(11);
    doc.text('Vehicle: ' + (vid || 'All Vehicles'), 40, 65);
    if (sd || ed){ doc.text('Date range: ' + (sd || '...') + ' to ' + (ed || '...'), 40, 82); }

    var y = 110;
    doc.setFontSize(13); doc.text('Totals', 40, 95);
    doc.setFontSize(12);
    doc.text('Total Income: AED ' + income.toFixed(2), 60, y); y+=20;
    doc.text('Total Expense: AED ' + expense.toFixed(2), 60, y); y+=20;
    doc.text('Net Balance: AED ' + net.toFixed(2), 60, y); y+=26;
    doc.setFontSize(11);
    doc.text('Transactions counted: ' + String(list.length), 40, y); y+=20;

    var c = document.createElement('canvas'); c.width=420; c.height=220;
    var ctx = c.getContext('2d');
    var chart = new Chart(ctx, { type:'pie', data:{ labels:['Income','Expense'], datasets:[{ data:[income,expense] }] }, options:{ responsive:false, plugins:{ legend:{display:true, position:'right'} } } });
    var img = c.toDataURL('image/png', 1.0);
    doc.addImage(img, 'PNG', 40, y, 420, 220);
    try{ chart.destroy(); }catch(e){}
    y += 240;

    var rows = list.slice(0,20).map(t=>[t.date||'', t.category||'', t.id||'', t.account||'', Number(t.amount||0).toFixed(2), t.type||'']);
    doc.autoTable({ startY: y, head:[['Date','Category','Vehicle ID','Account','Amount','Type']], body: rows, styles:{ fontSize:9 } });

    doc.save('vehicle_summary.pdf');
  }catch(e){ console.error('Vehicle PDF export failed', e); }
}


</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  var inc = document.getElementById('btnTypeIncome');
  var exp = document.getElementById('btnTypeExpense');
  function handlerFactory(type){
    return function(ev){
      try{
        ev.preventDefault(); ev.stopPropagation();
      }catch(e){}
      if (typeof setTxnType === 'function'){ setTxnType(type); }
      return false;
    }
  }
  if(inc && !inc._vrBound){ inc.addEventListener('click', handlerFactory('income')); inc._vrBound=true; }
  if(exp && !exp._vrBound){ exp.addEventListener('click', handlerFactory('expense')); exp._vrBound=true; }
});
</script>


<script>
(function(){
  function norm(str){
    return (str||'').toString().trim().toLowerCase().replace(/\s+/g,'').replace(/[-_]/g,'');
  }
  function coerce(n){ var x = parseFloat(n); return isNaN(x)?0:x; }

  window._vrGetAllTx = function(){
    try{
      if (window.state && Array.isArray(window.state.transactions)) {
        return window.state.transactions.map(x => ({
          date: x.date || '',
          category: x.category || '',
          id: x.transactionId || x.id || x.ID || '',
          vendor: x.vendor || '',
          account: x.account || '',
          amount: coerce(x.amount),
          description: x.description || '',
          type: (x.type||'').toLowerCase()
        }));
      }
    }catch(e){}
    try{
      if (Array.isArray(window.transactions)) {
        return window.transactions.map(x => ({
          date: x.date || x.Date || '',
          category: x.category || x.Category || '',
          id: x.transactionId || x.id || x.ID || '',
          vendor: x.vendor || x.Vendor || '',
          account: x.account || x.Account || '',
          amount: coerce(x.amount || x.Amount),
          description: x.description || x.Description || '',
          type: (x.type || x.Type || '').toLowerCase()
        }));
      }
    }catch(e){}
    try{
      var raw = localStorage.getItem('transactions');
      if (raw){
        var arr = JSON.parse(raw);
        if (Array.isArray(arr)){
          return arr.map(x => ({
            date: x.date || '',
            category: x.category || '',
            id: x.transactionId || x.id || x.ID || '',
            vendor: x.vendor || '',
            account: x.account || '',
            amount: coerce(x.amount),
            description: x.description || '',
            type: (x.type||'').toLowerCase()
          }));
        }
      }
    }catch(e){}
    try{
      var ret = [];
      ['#transactionsTable','#dashboardTransactionsTable'].forEach(function(sel){
        var rows = Array.from(document.querySelectorAll(sel + ' tbody tr'));
        rows.forEach(function(tr){
          var tds = tr.querySelectorAll('td');
          if (tds.length >= 8){
            ret.push({
              date: (tds[0].textContent||'').trim(),
              category: (tds[1].textContent||'').trim(),
              id: (tds[2].textContent||'').trim(),
              vendor: (tds[3].textContent||'').trim(),
              account: (tds[4].textContent||'').trim(),
              amount: coerce((tds[5].textContent||'').trim()),
              description: (tds[6].textContent||'').trim(),
              type: (tds[7].textContent||'').trim().toLowerCase()
            });
          }
        });
      });
      if (ret.length) return ret;
    }catch(e){}
    return [];
  };

  window.filterVehicleTransactions = function(vehicleId){
    var all = window._vrGetAllTx();
    var idNorm = norm(vehicleId);
    if(!idNorm) return [];
    return all.filter(function(txn){
      var cat = (txn.category||'').toLowerCase();
      var isVeh = cat === 'vehicle' || cat === 'vehicles' || cat.indexOf('vehicle') !== -1;
      var idValNorm = norm(txn.id);
      return isVeh && (idValNorm === idNorm || idValNorm.indexOf(idNorm) !== -1 || idNorm.indexOf(idValNorm) !== -1);
    });
  };

  window.renderVehicleSummary = function(list){
    var income=0, expense=0;
    list.forEach(function(x){ if(x.type==='income') income+=coerce(x.amount); else expense+=coerce(x.amount); });
    var net = income - expense;
    var host = document.getElementById('vrSummary');
    if(!host) return;
    host.innerHTML = '';

    function card(t, v, cls){
      var d=document.createElement('div'); d.className='vr-card';
      var tt=document.createElement('div'); tt.className='vr-title'; tt.textContent=t;
      var vv=document.createElement('div'); vv.className='vr-value ' + (cls||''); vv.textContent=v;
      d.appendChild(tt); d.appendChild(vv); return d;
    }
    host.appendChild(card('Total Income', 'AED ' + income.toFixed(2), 'positive-amount'));
    host.appendChild(card('Total Expense', 'AED ' + expense.toFixed(2), 'negative-amount'));
    host.appendChild(card('Net', 'AED ' + net.toFixed(2), net>=0 ? 'positive-amount' : 'negative-amount'));
    host.appendChild(card('Transactions', String(list.length)));
  };

  window.renderVehicleTable = function(list){
    var tbody = document.querySelector('#vehicleReportTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    if(!list.length){
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 8;
      td.textContent = 'No matching entries found. Make sure Category is "Vehicle/Vehicles" and ID matches the vehicle number.';
      tr.appendChild(td); tbody.appendChild(tr); return;
    }
    list.forEach(function(x){
      var tr = document.createElement('tr');
      function td(txt){ var d=document.createElement('td'); d.textContent = txt; return d; }
      tr.appendChild(td(x.date||''));
      tr.appendChild(td(x.category||''));
      tr.appendChild(td(x.id||''));
      tr.appendChild(td(x.vendor||''));
      tr.appendChild(td(x.account||''));
      tr.appendChild(td((x.amount!=null? Number(x.amount).toFixed(2):'') ));
      tr.appendChild(td(x.description||''));
      tr.appendChild(td((x.type||'').charAt(0).toUpperCase() + (x.type||'').slice(1)));
      tbody.appendChild(tr);
    });
  };

  window.runVehicleReport = function(){
    var input = document.getElementById('vrVehicleId');
    var vid = input ? input.value : '';
    var list = window.filterVehicleTransactions(vid);
    window.renderVehicleSummary(list);
    window.renderVehicleTable(list);
  };

  window.clearVehicleReport = function(){
    var input = document.getElementById('vrVehicleId');
    if(input) input.value='';
    window.renderVehicleSummary([]);
    window.renderVehicleTable([]);
  };
})();
</script>


<script>
function _asYMD(dstr){
  if(!dstr) return '';
  dstr = String(dstr).trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(dstr)) return dstr;
  if(/^\d{2}-\d{2}-\d{4}$/.test(dstr)){
    var p=dstr.split('-'); return p[2]+'-'+p[1]+'-'+p[0];
  }
  var dt = new Date(dstr); if(!isNaN(dt)) {
    var mm = String(dt.getMonth()+1).padStart(2,'0');
    var dd = String(dt.getDate()).padStart(2,'0');
    return dt.getFullYear()+'-'+mm+'-'+dd;
  }
  return dstr;
}

// Format date as 01-Jan-2025
function formatDisplayDate(dateStr) {
  if(!dateStr) return '';
  const dt = new Date(dateStr);
  if(isNaN(dt)) return dateStr;
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const day = String(dt.getDate()).padStart(2,'0');
  const month = months[dt.getMonth()];
  const year = dt.getFullYear();
  return `${day}-${month}-${year}`;
}

// Format amount as 4,554,455 (with commas, no decimals)
function formatDisplayAmount(amount) {
  if(!amount && amount !== 0) return '';
  const num = parseFloat(amount);
  if(isNaN(num)) return amount;
  return Math.round(num).toLocaleString('en-US');
}
</script>

<!-- Local Storage Only - No Cloud Sync -->
<script>
// Initialize app on page load
document.addEventListener('DOMContentLoaded', function() {
  // Load categories and accounts if empty
  if(state.categories.length === 0) {
    state.categories = ['Parts', 'Labor', 'Supplies', 'Equipment', 'Marketing', 'Rent', 'Utilities', 'Insurance', 'Other'];
    LS.set('categories', state.categories);
  }
  
  if(state.accounts.length === 0) {
    state.accounts = ['Cash', 'Bank - Current', 'Bank - Savings', 'Credit Card', 'Other'];
    LS.set('accounts', state.accounts);
  }
  
  // Initialize UI and load all data
  loadAllData();
  
  // Ensure transactions section is visible if logged in
  const sessionUser = sessionStorage.getItem('currentUser');
  if (sessionUser) {
    try {
      state.currentUser = JSON.parse(sessionUser);
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('menu').classList.remove('hidden');
      document.getElementById('currentUser').textContent = state.currentUser.username;
      showSection('transactions');
    } catch(e) {
      console.warn('Session restore failed', e);
    }
  }
});
</script>

</body>

</html>